<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tron Ads Faucet</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <script src="https://adexora.com/cdn/ads.js?id=494"></script>

    <style>
        /* CSS Variables for Theming - RED & WHITE */
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color: #f0f2f5; /* Light background for body */
            --card-bg: #ffffff;
            --text-color: #1c1c1e;
            --subtle-text: #888;
            --primary-color: #D32F2F; /* Deep Red */
            --primary-color-hover: #B71C1C;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        /* Header */
        .header { padding: 20px; display: flex; align-items: center; justify-content: space-between; background-color: var(--primary-color); color: white; border-radius: 0 0 var(--radius) var(--radius); box-shadow: var(--shadow); }
        .header h1 { font-size: 1.4rem; font-weight: 800; }
        .header-stats { text-align: right; font-size: 0.9rem; }
        .header-stats p strong { display: block; font-size: 1.1rem; }

        /* Main Content & Pages */
        main { padding: 15px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.6rem; margin-bottom: 20px; color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 10px; }
        
        /* Card Styles */
        .card { padding: 20px; border-radius: var(--radius); background-color: var(--card-bg); box-shadow: var(--shadow); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        /* Action Button (Primary Red) */
        .action-btn { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 700; color: #fff; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; display: flex; justify-content: center; align-items: center; background-color: var(--primary-color); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:hover { background-color: var(--primary-color-hover); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Menu Page - Balance */
        .balance-card { text-align: center; border: 2px solid var(--primary-color); background-color: #FFF3F3; }
        .balance-card .usd-value { font-size: 3rem; font-weight: 800; color: var(--primary-color); line-height: 1.2; }
        .balance-card .trx-value { font-size: 1.2rem; color: var(--subtle-text); margin-top: 5px; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .menu-tile { padding: 15px; border-radius: var(--radius); text-align: center; background-color: var(--card-bg); box-shadow: var(--shadow); cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .menu-tile i { font-size: 2rem; color: var(--primary-color); margin-bottom: 10px; }
        .menu-tile span { font-size: 1rem; font-weight: 600; display: block; }
        .menu-tile:hover { background-color: #FFFAFA; }

        /* Form Elements (Shared) */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 700; font-size: 0.95rem; color: var(--text-color); }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border-radius: 8px; font-family: inherit; font-size: 1rem; border: 1px solid var(--border-color); transition: border-color 0.2s; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: var(--primary-color); outline: none; }
        
        /* Referral & Copy */
        .input-group { display: flex; margin-bottom: 15px; }
        .input-group input { flex-grow: 1; border-radius: 8px 0 0 8px; border-right: none; background-color: var(--bg-color); }
        .input-group button { padding: 10px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 0 8px 8px 0; cursor: pointer; transition: background-color 0.2s; }
        .input-group button:hover { background-color: var(--primary-color-hover); }

        /* Withdrawal Details */
        .withdraw-note { font-size: 0.9rem; color: var(--subtle-text); margin-top: 10px; }
        
        /* Admin Panel */
        #admin-panel .stat-display { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--border-color); font-weight: 600; }
        #admin-panel h3 { margin-top: 20px; color: var(--primary-color); }
        #admin-panel ul { list-style: none; padding: 0; }
        #admin-panel li { border: 1px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; background-color: #FFEEEE; }
        #admin-panel li strong { color: var(--primary-color); }
        #admin-panel li button { margin-top: 10px; margin-right: 5px; padding: 8px 12px; border-radius: 5px; font-weight: 700; cursor: pointer; }
        #admin-panel .approve-btn { background-color: #4CAF50; color: white; border: none; }
        #admin-panel .reject-btn { background-color: #f44336; color: white; border: none; }


        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; display: flex; justify-content: space-around; padding: 5px 0; background-color: var(--card-bg); border-top: 1px solid var(--border-color); box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); z-index: 1000; }
        .nav-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; padding: 5px 10px; font-family: var(--font-family); font-size: 0.75rem; transition: color 0.2s; flex-grow: 1; color: var(--subtle-text); }
        .nav-btn i { font-size: 1.6rem; margin-bottom: 3px; }
        .nav-btn.active { font-weight: 700; color: var(--primary-color); }

        /* Modal & Loader */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; }
        .modal-content { padding: 30px; border-radius: 15px; text-align: center; background-color: white; box-shadow: var(--shadow); }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app">
        <header class="header">
            <div>
                <h1>TRON Ads Faucet</h1>
                <p style="font-size:0.9rem;">The simplest way to earn TRX.</p>
            </div>
            <div class="header-stats">
                <p>Current Price (TRX)</p>
                <p><strong>$<span id="current-trx-price">0.0000</span></strong></p>
                <div id="admin-indicator" style="display:none; font-weight:bold; color:#FFD700; margin-top:5px;">ADMIN MODE</div>
            </div>
        </header>

        <main id="main-content">
            
            <div id="admin-panel" class="page">
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                <div class="card">
                    <h3>System Stats</h3>
                    <div class="stat-display"><span>Total Users:</span> <strong id="admin-user-count">0</strong></div>
                    <div class="stat-display"><span>Total User Balance (USD):</span> <strong id="admin-total-balance">$0.00</strong></div>
                </div>
                
                <h3 style="margin-top:25px;">Pending Withdrawal Requests</h3>
                <ul id="withdrawal-list">
                    <p style="color:var(--subtle-text);">Loading requests...</p>
                </ul>
            </div>

            <div id="menu-page" class="page active">
                <h2><i class="fas fa-bars"></i> Main Menu</h2>
                <div class="card balance-card">
                    <p style="font-size:1.1rem; color:var(--subtle-text);">Your Current Balance</p>
                    <div class="usd-value">$<span id="menu-balance-usd">0.00</span></div>
                    <div class="trx-value">â‰ˆ <span id="menu-balance-trx">0.0000</span> TRX</div>
                </div>
                
                <div class="menu-grid">
                    <div onclick="showSection('ad-section')" class="menu-tile">
                        <i class="fas fa-play-circle"></i>
                        <span>View Ad (Today: <span id="daily-ads-watched">0</span>/100)</span>
                    </div>
                    <div onclick="showSection('friends-page')" class="menu-tile">
                        <i class="fas fa-users"></i>
                        <span>Friends & Referrals</span>
                    </div>
                    <div onclick="showSection('withdraw-page')" class="menu-tile">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw TRX</span>
                    </div>
                    <div onclick="showSection('rules-page')" class="menu-tile" style="background-color:#fefefe;">
                        <i class="fas fa-gavel" style="color:#222;"></i>
                        <span style="color:#222;">Rules</span>
                    </div>
                </div>
            </div>

            <div id="ad-section" class="page">
                <h2><i class="fas fa-video"></i> Watch Ad</h2>
                <div class="card" style="text-align: center;">
                    <i class="fas fa-dollar-sign" style="font-size:3rem; color: var(--primary-color);"></i>
                    <h3>Watch & Earn</h3>
                    <p style="margin-bottom:15px;">You earn **$0.001** per rewarded ad.</p>
                    <button id="watch-ad-btn" class="action-btn">
                        <i class="fas fa-check-circle" style="margin-right:10px;"></i> Start Ad
                    </button>
                    <p class="withdraw-note" style="margin-top:10px;">Ads Watched Today: <strong id="ad-section-watched">0</strong> / 100</p>
                </div>
            </div>

            <div id="friends-page" class="page">
                <h2><i class="fas fa-user-friends"></i> Referral System</h2>
                <div class="card">
                    <p style="font-weight:700; color:var(--primary-color);">Referral Bonus: Get **$0.02** worth of TRX for every successful friend!</p>
                    
                    <h3 style="font-size:1.2rem; margin-top:15px; margin-bottom:5px;">Your Referral Code (Telegram ID)</h3>
                    <div class="input-group">
                        <input type="text" id="referral-code-input" value="Loading..." readonly>
                        <button onclick="copyToClipboard('referral-code-input')"><i class="fas fa-copy"></i> Copy</button>
                    </div>
                    
                    <button id="share-ref-btn" class="action-btn" style="margin-top:0;"><i class="fas fa-share-alt" style="margin-right:10px;"></i> Share Promotional Text</button>

                    <h3 style="font-size:1.2rem; margin-top:25px; margin-bottom:5px;">Enter Friend's Code</h3>
                    <p class="withdraw-note">You can only use one code once.</p>
                    <div class="input-group">
                        <input type="text" id="enter-referrer-code" placeholder="Enter friend's Telegram ID">
                        <button onclick="applyReferralCode()"><i class="fas fa-arrow-right"></i> Apply</button>
                    </div>
                </div>
            </div>
            
            <div id="withdraw-page" class="page">
                <h2><i class="fas fa-money-check-alt"></i> Withdraw TRX</h2>
                <div class="card balance-card" style="margin-bottom: 20px;">
                    <p style="font-size:0.9rem; color:var(--subtle-text);">Available TRX:</p>
                    <div class="usd-value" style="font-size:2rem;"><span id="withdraw-balance-trx">0.0000</span> TRX</div>
                </div>
                <p style="font-weight:700;">Minimum withdrawal is **0.01 TRX**.</p>
                <form id="withdraw-form" style="margin-top:15px;">
                    <div class="form-group">
                        <label for="tron-address"><i class="fas fa-truck-moving"></i> TRON Wallet Address:</label>
                        <input type="text" id="tron-address" placeholder="Txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    </div>
                    <div class="form-group">
                        <label for="amount-usd"><i class="fas fa-dollar-sign"></i> Amount (USD):</label>
                        <input type="number" id="amount-usd" step="0.0001" placeholder="e.g., 1.00" required>
                    </div>
                    <p class="withdraw-note">You will receive: <strong id="receive-trx-amount">0.0000</strong> TRX</p>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn" style="margin-top:15px;">
                        <i class="fas fa-paper-plane" style="margin-right:10px;"></i> Submit Withdrawal Request
                    </button>
                </form>
            </div>
            
            <div id="rules-page" class="page">
                <h2><i class="fas fa-gavel"></i> Rules</h2>
                <div class="card">
                    <ul style="padding-left:20px; font-size:0.95rem;">
                        <li style="margin-bottom:10px;">**Earnings Policy:** Users earn **$0.001** for each ad viewed.</li>
                        <li style="margin-bottom:10px;">**Daily Limit:** The maximum number of ads a user can view per day is **100**.</li>
                        <li style="margin-bottom:10px;">**Referral Bonus:** Users receive **$0.02** worth of TRX for each successful manual referral.</li>
                        <li style="margin-bottom:10px;">**Withdrawal Threshold:** The minimum withdrawal amount is **0.01 TRX**. Only TRON (TRX) withdrawals are supported.</li>
                        <li style="margin-bottom:10px;">**Fair Use:** Any attempt to use bots, VPNs, or manipulate the system to artificially increase earnings will result in an immediate and permanent **account ban**.</li>
                        <li style="margin-bottom:0;">**Processing Time:** Withdrawal requests are processed manually by the admin and may take up to **48 hours**.</li>
                    </ul>
                </div>
            </div>

        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="menu-page"><i class="fas fa-home"></i><span>Menu</span></button>
            <button class="nav-btn" data-page="friends-page"><i class="fas fa-users"></i><span>Friends</span></button>
            <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
        </nav>
    </div>

    <div id="loading-modal" class="modal">
        <div class="modal-content"><div class="loader"></div><p>Processing request...</p></div>
    </div>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
        import { getDatabase, ref, get, set, update, onValue, push, serverTimestamp, query, orderByChild } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        
        // --- CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCGGHZROaP3RkFs-a293uTFaWn521y3BeM",
            authDomain: "tronadsfaucet.firebaseapp.com",
            databaseURL: "https://tronadsfaucet-default-rtdb.firebaseio.com",
            projectId: "tronadsfaucet",
            storageBucket: "tronadsfaucet.firebasestorage.app",
            messagingSenderId: "26180984735",
            appId: "1:26180984735:web:e498a635c4f61bd0a167aa",
            measurementId: "G-WG3ETVHC78"
        };
        const ADMIN_TELEGRAM_IDS = ["7904032877"];
        const AD_LIMIT = 100;
        const EARNINGS_PER_AD_USD = 0.001;
        const REFERRAL_BONUS_USD = 0.02;
        const MIN_WITHDRAW_TRX = 0.01;
        const BOT_USERNAME = "TronAdsFaucetBot"; 
        const TELEGRAM_LINK = `https://t.me/${BOT_USERNAME}`;

        // --- GLOBAL STATE ---
        let currentTronPriceUsd = 0.0; 
        let userUid = null;
        let telegramId = null;

        // --- FIREBASE INITIALIZATION (Realtime Database Only) ---
        const app = initializeApp(FIREBASE_CONFIG);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // --- UTILITY FUNCTIONS ---
        const getUidFromTelegramId = (id) => `tg_user_${id}`;
        
        // Navigation Handler
        window.showSection = (sectionId) => {
            document.querySelectorAll('.page').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-page="${sectionId}"]`)?.classList.add('active');

            if (sectionId === 'admin-panel') loadAdminPanel();
        }

        // Copy to Clipboard
        window.copyToClipboard = (elementId) => {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value).then(() => {
                window.Telegram.WebApp.showAlert("Code copied to clipboard!");
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            });
        }
        
        // --- DATA FETCHING & UI UPDATES ---
        
        async function fetchTronPrice() {
            try {
                // Fetching live price (Requires CORS proxy or server-side fetch in a production environment)
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tron&vs_currencies=usd');
                const data = await response.json();
                currentTronPriceUsd = data.tron.usd;
                document.getElementById('current-trx-price').textContent = currentTronPriceUsd.toFixed(4);
            } catch (error) {
                console.error("Error fetching Tron price, using fallback:", error);
                currentTronPriceUsd = 0.03389; // Fallback value
                document.getElementById('current-trx-price').textContent = `F: ${currentTronPriceUsd.toFixed(4)}`;
            }
        }
        
        // Real-time listener for user data
        function setupUserListener() {
            if (!userUid) return;
            const userRef = ref(database, 'users/' + userUid);
            
            onValue(userRef, (snapshot) => {
                let userData = snapshot.val();
                
                if (!snapshot.exists()) {
                    // Initialize New User
                    const user = window.Telegram.WebApp.initDataUnsafe.user;
                    const newUser = {
                        telegram_id: telegramId,
                        username: user?.username || `user_${telegramId}`,
                        first_name: user?.first_name || 'User',
                        balance_usd: 0.0,
                        referred_by: null,
                        daily_ads_watched: 0,
                        referral_code: telegramId.toString(),
                        created_at: serverTimestamp()
                    };
                    set(userRef, newUser);
                    userData = newUser;
                }

                const balanceUsd = userData.balance_usd || 0.0;
                const balanceTrx = balanceUsd / currentTronPriceUsd;
                const dailyWatched = userData.daily_ads_watched || 0;

                // Update UI
                document.getElementById('menu-balance-usd').textContent = balanceUsd.toFixed(2);
                document.getElementById('menu-balance-trx').textContent = balanceTrx.toFixed(4);
                document.getElementById('withdraw-balance-trx').textContent = balanceTrx.toFixed(4);
                document.getElementById('daily-ads-watched').textContent = dailyWatched;
                document.getElementById('ad-section-watched').textContent = dailyWatched;
                document.getElementById('referral-code-input').value = userData.referral_code;

                // Update referral section for users who already applied a code
                if (userData.referred_by) {
                    document.getElementById('enter-referrer-code').disabled = true;
                    document.getElementById('enter-referrer-code').placeholder = `Already referred by: ${userData.referred_by}`;
                    document.querySelector('#friends-page .input-group button').disabled = true;
                }
            });
        }
        
        // --- AD VIEW LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('watch-ad-btn').addEventListener('click', handleWatchAd);
        });
        
        const handleWatchAd = () => {
            const userRef = ref(database, 'users/' + userUid);
            
            get(userRef).then((snapshot) => {
                const userData = snapshot.val();
                let adsWatched = userData.daily_ads_watched || 0;
                const currentBalance = userData.balance_usd || 0.0;

                if (adsWatched >= AD_LIMIT) {
                    return window.Telegram.WebApp.showAlert(`You have reached the daily ad viewing limit (${AD_LIMIT}).`);
                }

                document.getElementById('loading-modal').style.display = 'flex';
                document.getElementById('loading-modal').querySelector('p').textContent = 'Loading Ad...';

                // Adexora integration
                window.showAdexora()
                  .then(() => {
                    adsWatched++;
                    const newBalance = currentBalance + EARNINGS_PER_AD_USD;

                    // Update user data in Firebase
                    update(userRef, {
                        balance_usd: newBalance,
                        daily_ads_watched: adsWatched,
                        last_ad_viewed: serverTimestamp()
                    });
                    
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    window.Telegram.WebApp.showAlert(`Success! You earned $${EARNINGS_PER_AD_USD.toFixed(3)}.`);
                  })
                  .catch(e => {
                    window.Telegram.WebApp.showAlert("Ad not shown or skipped. Please try again.");
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                  })
                  .finally(() => {
                    document.getElementById('loading-modal').style.display = 'none';
                  });
            });
        }

        // --- REFERRAL LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('share-ref-btn').addEventListener('click', handleShareReferral);
        });

        const handleShareReferral = () => {
            const userCode = document.getElementById('referral-code-input').value;
            const balanceUsd = parseFloat(document.getElementById('menu-balance-usd').textContent).toFixed(2);
            
            // Share message as requested
            const shareText = `Earnings of $0.30 to $3 per day!\nTron Coin Ads Faucet\nUse it to Make Money (Referral Code: ${userCode})\n${TELEGRAM_LINK}`;
            
            if (navigator.share) {
                navigator.share({ title: 'Tron Ads Faucet', text: shareText });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    window.Telegram.WebApp.showAlert("Promotional text copied to clipboard!");
                });
            }
        }

        window.applyReferralCode = () => {
            const referrerCode = document.getElementById('enter-referrer-code').value.trim();
            const userRef = ref(database, 'users/' + userUid);

            if (!referrerCode) return window.Telegram.WebApp.showAlert("Please enter a referral code.");
            if (referrerCode === telegramId) return window.Telegram.WebApp.showAlert("You cannot refer yourself.");

            get(userRef).then((snapshot) => {
                if (snapshot.val()?.referred_by) {
                    return window.Telegram.WebApp.showAlert("You have already used a referral code.");
                }
                
                const referrerUid = getUidFromTelegramId(referrerCode); 
                const referrerRef = ref(database, 'users/' + referrerUid);

                get(referrerRef).then(rSnapshot => {
                    if (!rSnapshot.exists()) return window.Telegram.WebApp.showAlert("Invalid referral code. User not found.");
                    
                    // 1. Grant bonus to referrer
                    const rData = rSnapshot.val();
                    const newReferrerBalance = (rData.balance_usd || 0.0) + REFERRAL_BONUS_USD;
                    
                    update(referrerRef, {
                        balance_usd: newReferrerBalance
                    });

                    // 2. Update the referred user's data
                    update(userRef, {
                        referred_by: referrerCode,
                        referral_applied_at: serverTimestamp() 
                    }).then(() => {
                        window.Telegram.WebApp.showAlert(`Referral code applied successfully! Your referrer received $${REFERRAL_BONUS_USD} in TRX.`);
                        document.getElementById('enter-referrer-code').value = '';
                    });
                });
            });
        }

        // --- WITHDRAWAL LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const amountInput = document.getElementById('amount-usd');
            const receiveTrx = document.getElementById('receive-trx-amount');
            amountInput.addEventListener('input', () => {
                const usd = parseFloat(amountInput.value);
                if (isNaN(usd) || usd <= 0 || currentTronPriceUsd === 0) {
                    receiveTrx.textContent = '0.0000';
                } else {
                    receiveTrx.textContent = (usd / currentTronPriceUsd).toFixed(4);
                }
            });
            document.getElementById('withdraw-form').addEventListener('submit', handleWithdrawSubmit);
        });

        const handleWithdrawSubmit = (e) => {
            e.preventDefault();
            const userRef = ref(database, 'users/' + userUid);
            const tronAddress = document.getElementById('tron-address').value.trim();
            const withdrawUsdAmount = parseFloat(document.getElementById('amount-usd').value);

            if (!tronAddress || !tronAddress.startsWith('T') || tronAddress.length < 34) {
                return window.Telegram.WebApp.showAlert("Please enter a valid TRON address (starts with 'T').");
            }
            if (isNaN(withdrawUsdAmount) || withdrawUsdAmount <= 0) {
                return window.Telegram.WebApp.showAlert("Please enter a valid amount.");
            }
            
            const amountInTrx = withdrawUsdAmount / currentTronPriceUsd;
            
            if (amountInTrx < MIN_WITHDRAW_TRX) {
                return window.Telegram.WebApp.showAlert(`Withdrawal failed: Minimum withdrawal is ${MIN_WITHDRAW_TRX} TRX.`);
            }

            document.getElementById('loading-modal').style.display = 'flex';
            document.getElementById('loading-modal').querySelector('p').textContent = 'Submitting Request...';

            get(userRef).then(snapshot => {
                const userData = snapshot.val();
                const usdBalance = userData?.balance_usd || 0.0;
                
                if (withdrawUsdAmount > usdBalance) {
                    document.getElementById('loading-modal').style.display = 'none';
                    return window.Telegram.WebApp.showAlert("Withdrawal failed: Insufficient balance.");
                }

                const newBalance = usdBalance - withdrawUsdAmount;

                // 1. Create a request in Firebase
                const requestRef = push(ref(database, 'withdrawal_requests'));
                
                requestRef.set({
                    user_id: userUid,
                    telegram_id: telegramId,
                    username: userData.username,
                    tron_address: tronAddress,
                    amount_usd: withdrawUsdAmount.toFixed(4),
                    amount_trx: amountInTrx.toFixed(4),
                    status: "Pending",
                    timestamp: serverTimestamp()
                }).then(() => {
                    // 2. Deduct the balance from the user's account
                    update(userRef, { balance_usd: newBalance });
                    window.Telegram.WebApp.showAlert(`Withdrawal request for ${amountInTrx.toFixed(4)} TRX submitted successfully.`);
                    document.getElementById('amount-usd').value = '';
                }).catch(e => {
                    window.Telegram.WebApp.showAlert("An error occurred during withdrawal submission.");
                }).finally(() => {
                    document.getElementById('loading-modal').style.display = 'none';
                });
            });
        }

        // --- ADMIN PANEL LOGIC ---
        function loadAdminPanel() {
            if (!ADMIN_TELEGRAM_IDS.includes(telegramId)) return;

            // 1. Load System Stats
            const usersRef = ref(database, 'users');
            onValue(usersRef, (snapshot) => {
                let totalBalance = 0.0;
                let userCount = 0;

                snapshot.forEach(userSnapshot => {
                    totalBalance += userSnapshot.val().balance_usd || 0.0;
                    userCount++;
                });

                document.getElementById('admin-user-count').textContent = userCount;
                document.getElementById('admin-total-balance').textContent = `$${totalBalance.toFixed(2)}`;
            });

            // 2. Load Withdrawal Requests (Ordered by oldest pending first)
            const requestsQuery = query(ref(database, 'withdrawal_requests'), orderByChild('status'));
            onValue(requestsQuery, (snapshot) => {
                const ul = document.getElementById('withdrawal-list');
                ul.innerHTML = ''; 
                let pendingCount = 0;

                snapshot.forEach(requestSnapshot => {
                    const request = requestSnapshot.val();
                    const requestId = requestSnapshot.key;

                    if (request.status === 'Pending') {
                        pendingCount++;
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <p><strong>User:</strong> ${request.username} (TG ID: ${request.telegram_id})</p>
                            <p><strong>Address:</strong> <code>${request.tron_address}</code></p>
                            <p><strong>Amount:</strong> ${request.amount_trx} TRX <strong>($${request.amount_usd})</strong></p>
                            <button onclick="processWithdrawal('${requestId}', 'Completed')" class="approve-btn"><i class="fas fa-check"></i> Approve</button>
                            <button onclick="processWithdrawal('${requestId}', 'Rejected')" class="reject-btn"><i class="fas fa-times"></i> Reject</button>
                        `;
                        ul.appendChild(li);
                    }
                });
                if (pendingCount === 0) {
                    ul.innerHTML = '<p style="color:green; font-weight:700;">No pending withdrawal requests.</p>';
                }
            });
        }

        window.processWithdrawal = (requestId, status) => {
            if (!ADMIN_TELEGRAM_IDS.includes(telegramId)) return;
            
            const requestRef = ref(database, 'withdrawal_requests/' + requestId);
            
            update(requestRef, {
                status: status,
                processed_by_admin: telegramId,
                processed_at: serverTimestamp()
            }).then(() => {
                window.Telegram.WebApp.showAlert(`Request ${requestId} set to ${status}.`);
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            });
        }

        // --- INITIALIZATION ---
        const initApp = async () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            const user = tg.initDataUnsafe.user;
            if (!user || !user.id) {
                tg.showAlert("Could not verify user. Please open this app through Telegram.", () => tg.close());
                return;
            }
            
            telegramId = user.id.toString();
            userUid = getUidFromTelegramId(telegramId);
            
            // Check and handle Admin access
            if (ADMIN_TELEGRAM_IDS.includes(telegramId)) {
                document.getElementById('admin-indicator').style.display = 'block';
                // Add Admin Panel button to Nav
                const nav = document.querySelector('.bottom-nav');
                const adminBtn = document.createElement('button');
                adminBtn.className = 'nav-btn';
                adminBtn.dataset.page = 'admin-panel';
                adminBtn.innerHTML = '<i class="fas fa-user-shield"></i><span>Admin</span>';
                adminBtn.onclick = () => showSection('admin-panel');
                nav.appendChild(adminBtn);
            }
            
            await fetchTronPrice();
            setupUserListener();
            showSection('menu-page'); 
        };

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
