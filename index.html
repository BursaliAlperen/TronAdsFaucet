<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>‚ö°Ô∏è TronAdsFaucet</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.5/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adexora.com/cdn/ads.js?id=494"></script>
    <style>
        :root {
            /* Red-White Theme Colors */
            --primary-color: #FF4136; /* Bright Red, close to Tron's color */
            --primary-dark: #CC0000;
            --secondary-color: #2ECC71; 
            --accent-color: #FFDC00; 
            --bg-light: #F9F9F9; /* Very Light Background */
            --bg-dark: #1A1A1A; /* Dark Theme Background */
            --card-bg-light: #FFFFFF;
            --card-bg-dark: #222222;
            --text-dark: #1A1A1A;
            --text-light: #F9F9F9;
            --border-color-light: #FFEDED; 
            --border-color-dark: #333333;

            /* General Settings */
            --border-radius: 16px; 
            --border-radius-sm: 10px;
            --transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }

        /* Dark Mode CSS */
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-light);
            --header-bg: linear-gradient(135deg, #1A1A1A, #333333);
            --card-bg: var(--card-bg-dark);
            --text-primary: var(--text-light);
            --text-secondary: #B0B0B0;
            --border-color: var(--border-color-dark);
            --input-bg: #333333;
            --input-border: #444444;
            --button-bg-secondary: #333333;
            --button-text-secondary: var(--primary-color);
            --toggle-bg: #333333;
        }

        /* Light Mode CSS (Red-White) */
        body:not(.dark-mode) {
            background-color: var(--bg-light);
            color: var(--text-dark);
            --header-bg: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            --card-bg: var(--card-bg-light);
            --text-primary: var(--text-dark);
            --text-secondary: #666666;
            --border-color: #E0E0E0; 
            --input-bg: #FFFFFF; 
            --input-border: #E0E0E0;
            --button-bg-secondary: #FFEDED;
            --button-text-secondary: var(--primary-color);
            --toggle-bg: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            transition: background-color var(--transition), color var(--transition);
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            background-color: var(--bg-light);
        }

        /* Header Section */
        .header {
            height: 190px;
            background: var(--header-bg);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--text-light);
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* Content Transition */
        .content-section {
            padding: 20px;
            margin-bottom: 80px;
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            min-height: 300px;
        }
        
        .content-section.active-content {
            opacity: 1;
            transform: translateY(0);
        }

        /* Card Animation */
        .profile-card {
            transition: var(--transition);
        }
        
        .profile-card:hover {
            box-shadow: 0 12px 40px rgba(255, 65, 54, 0.15); 
            transform: translateY(-5px);
        }

        /* Nav Icon Animation */
        .nav-item i {
            transition: var(--transition);
        }
        .nav-item:hover i {
            color: var(--primary-dark);
            transform: scale(1.15) rotate(-3deg);
        }
        /* Active icon pulse effect */
        .nav-item.active i {
            animation: pulse 0.6s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 0.9; }
            to { transform: scale(1.05); opacity: 1; }
        }

        /* Other Style Definitions (Shortened) */
        .header-title { font-size: 1.8rem; font-weight: 800; z-index: 2; letter-spacing: 1px; display: flex; align-items: center; }
        .tron-logo { width: 28px; height: 28px; margin-right: 10px; border-radius: 50%; background: white; padding: 3px; box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }
        .tron-logo svg { display: block; }
        .theme-toggle { position: absolute; top: 20px; right: 20px; width: 45px; height: 45px; border-radius: 50%; background: var(--toggle-bg); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 1.1rem; cursor: pointer; z-index: 10; transition: var(--transition); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        .profile-section { margin-top: -60px; padding: 0 20px; position: relative; z-index: 2; }
        .profile-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 70px 20px 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); border: 1px solid var(--border-color); position: relative; text-align: center; }
        .profile-pic { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; border-radius: 50%; border: 5px solid var(--card-bg); object-fit: cover; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); background: var(--primary-color); transition: var(--transition); }
        .profile-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; color: var(--text-primary); }
        .points-display { display: inline-flex; align-items: center; background: rgba(255, 65, 54, 0.1); padding: 8px 18px; border-radius: 50px; margin-top: 10px; font-weight: 800; color: var(--primary-color); font-size: 1.3rem; border: 2px solid var(--primary-color); box-shadow: 0 2px 5px rgba(255, 65, 54, 0.3); }
        .stats-display { display: flex; justify-content: space-around; gap: 15px; margin-top: 25px; }
        .stat-item { background: var(--input-bg); padding: 12px 10px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); flex: 1; transition: var(--transition); }
        .stat-item:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-color: var(--primary-color); }
        .stat-value { font-weight: 800; color: var(--primary-dark); margin-bottom: 4px; font-size: 1.2rem; transition: color 0.3s; }
        body.dark-mode .stat-value { color: var(--primary-color); }
        .stat-label { font-size: 0.8rem; opacity: 0.7; color: var(--text-secondary); }
        .task-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); transition: var(--transition); }
        .task-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15); }
        .btn { display: block; width: 100%; padding: 18px; border-radius: var(--border-radius); border: none; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: var(--transition); text-align: center; text-decoration: none; font-family: 'Inter', sans-serif; margin-top: 20px; position: relative; overflow: hidden; }
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 8px 20px rgba(255, 65, 54, 0.5); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-4px); box-shadow: 0 10px 25px rgba(255, 65, 54, 0.6); }
        .btn-primary:active { transform: translateY(-1px); }
        .btn i { margin-right: 8px; transition: transform 0.3s; }
        .btn:hover i { transform: scale(1.1) rotate(5deg); }
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); background: var(--card-bg); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1); z-index: 100; max-width: 480px; width: 100%; border-top: 1px solid var(--border-color); border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); text-decoration: none; font-size: 0.8rem; font-weight: 600; flex: 1; padding: 5px 0; transition: var(--transition); cursor: pointer; }
        .nav-item i { font-size: 1.6rem; margin-bottom: 4px; transition: var(--transition); }
        .nav-item.active { color: var(--primary-color); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .ad-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .ad-modal { max-width: 350px; width: 90%; padding: 30px; background: var(--card-bg); border-radius: var(--border-radius); text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .ad-modal-title { color: var(--primary-dark); font-weight: 800; }
        body.dark-mode .ad-modal-title { color: var(--primary-color); }
        .section-title { font-size: 1.5rem; font-weight: 800; color: var(--primary-color); margin-bottom: 20px; display: flex; align-items: center; }
        .section-title i { margin-right: 12px; font-size: 1.4rem; }
        .reward-badge { background: var(--primary-color); color: white; padding: 6px 15px; border-radius: 50px; font-size: 1rem; font-weight: 700; margin-top: 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); display: inline-block; }
        .input-field { width: 100%; padding: 14px 18px; border-radius: var(--border-radius-sm); font-size: 1rem; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary); margin-top: 5px; }
        .input-field:focus { outline: none; box-shadow: 0 0 0 3px rgba(255, 65, 54, 0.3); }
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: var(--text-secondary); }
        .referral-input-group .copy-btn { background: var(--primary-color); }
        .referral-container { background: var(--input-bg); border-radius: var(--border-radius-sm); padding: 15px; margin-bottom: 20px; border: 2px dashed var(--primary-color); }
        .referral-input-group { display: flex; margin-bottom: 10px; }
        .referral-input { flex: 1; padding: 9px 12px; border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm); border: 1px solid var(--input-border); background: var(--card-bg); color: var(--text-primary); font-size: 0.9rem; height: auto; }
        .copy-btn { padding: 0 14px; background: var(--primary-color); color: white; border: none; border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0; font-weight: 600; cursor: pointer; transition: var(--transition); font-size: 0.9rem; }
        .admin-stat-card { background: var(--input-bg); border-radius: var(--border-radius-sm); padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--primary-color); font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .admin-request-item { background: var(--card-bg); padding: 15px; border-radius: var(--border-radius-sm); margin-bottom: 10px; border: 1px solid var(--border-color); }
        .request-actions button { transition: transform 0.2s; padding: 10px; border-radius: var(--border-radius-sm); border: none; font-weight: 600; cursor: pointer; color: white; }
        .request-actions .approve { background: var(--secondary-color); }
        .request-actions .reject { background: var(--primary-dark); }
        .request-actions button:hover { transform: scale(1.02); }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2); z-index: 1000; opacity: 0; transition: all 0.3s ease; font-size: 0.85rem; max-width: 90%; text-align: center; }
        .toast.show { opacity: 1; bottom: 90px; }
        .error-message { color: var(--primary-color); font-weight: 600; }
        .success-message { color: var(--secondary-color); font-weight: 600; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <h1 class="header-title">
                <svg viewBox="0 0 448 512" class="tron-logo" xmlns="http://www.w3.org/2000/svg"><path fill="#FF4136" d="M424.4 200.7H239.5L160 279.3H424.4V200.7zM424.4 311.3H160L239.5 390H424.4V311.3zM448 0H0v512h448V0zm-40 472H40V40h368v432zM199.5 160V112h-80v48h80zm0 240v48h-80v-48h80z"/></svg>
                TronAdsFaucet
            </h1>
            <p style="font-size: 0.9rem; z-index: 2;" id="tronPriceDisplay">TRX/USD: Loading...</p>
        </div>

        <div class="profile-section">
            <div class="profile-card">
                <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" alt="Profile" class="profile-pic" id="profilePic">
                <h1 class="profile-name" id="profileNameDisplay">
                    User
                    <i class="fas fa-check-circle verified-badge" style="color: var(--secondary-color); margin-left: 8px;"></i>
                    <button class="edit-name-btn" id="editNameBtn">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </h1>
                <div class="points-display" id="userPointsDisplay">
                    <i class="fas fa-wallet" style="margin-right: 8px; color: var(--primary-dark);"></i> 0.0000 TRX
                </div>
                <div class="stats-display">
                    <div class="stat-item">
                        <div class="stat-value" id="adsWatchedToday">0</div>
                        <div class="stat-label">Watched Today</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="adRewardValue">~0.0029 TRX</div>
                        <div class="stat-label">Per Ad</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalAdsWatched">0</div>
                        <div class="stat-label">Total Watched</div>
                    </div>
                </div> 
            </div>
        </div>

        <div class="content-section" id="mainContent">
            </div>

        <div class="bottom-nav">
            <a href="#" class="nav-item active" data-page="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" data-page="withdraw">
                <i class="fas fa-hand-holding-usd"></i>
                <span>Withdraw</span>
            </a>
            <a href="#" class="nav-item" data-page="referral">
                <i class="fas fa-users"></i>
                <span>Referral</span>
            </a>
            <a href="#" class="nav-item admin-only" data-page="admin" id="adminNav" style="display: none;">
                <i class="fas fa-user-shield"></i>
                <span>Admin</span>
            </a>
        </div>

        <div class="ad-modal-overlay" id="adModal" style="opacity: 0; pointer-events: none; transition: opacity 0.3s ease;">
            <div class="ad-modal">
                <h3 class="ad-modal-title" id="adModalTitle">Ad Loading...</h3>
                <div class="spinner" id="adSpinner"></div>
                <p class="ad-status" id="adStatusMessage">Please wait for the ad to load.</p>
                <button class="btn btn-primary" id="adCloseBtn" style="display: none;">Close & Claim Reward</button>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        // CONFIGURATION
        const APP_NAME = "TronAdsFaucet";
        const ADMIN_TELEGRAM_ID = 7904032877;
        const REWARD_USD_PER_AD = 0.0005; // G√úNCELLENDƒ∞: Reklam ba≈üƒ± $0.0005 USD
        const REFERRAL_BONUS_USD_REFERRER = 0.0005; // $0.0005 USD
        const REFERRAL_BONUS_USD_REFEREE = 0.0002; // $0.0002 USD
        const MIN_WITHDRAW_TRX = 0.01; // G√úNCELLENDƒ∞: Minimum √ßekim 0.01 TRX
        const TELEGRAM_BOT_USERNAME = "TronAdsFaucetBot";
        
        // Telegram Bot/Channel Info
        const TELEGRAM_BOT_TOKEN = "7354534121:AAHssrmmk3zam5STFXWnOjNRqKyexOjXvmE"; 
        const TELEGRAM_CHAT_ID = "-1002783990004"; 
        const DEVELOPER_TELEGRAM_PROFILE_LINK = "https://t.me/freeinternet_bd25"; 

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCGGHZROaP3RkFs-a293uTFaWn521y3BeM",
            authDomain: "tronadsfaucet.firebaseapp.com",
            databaseURL: "https://tronadsfaucet-default-rtdb.firebaseio.com",
            projectId: "tronadsfaucet",
            storageBucket: "tronadsfaucet.firebasestorage.app",
            messagingSenderId: "26180984735",
            appId: "1:26180984735:web:e498a635c4f61bd0a167aa",
            measurementId: "G-WG3ETVHC78"
        };
        
        // GLOBAL STATE
        let currentUser = {
            name: 'User',
            telegramId: null,
            photoUrl: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
            balanceTRX: 0.00,
            adsWatchedToday: 0,
            totalAdsWatchedLifetime: 0,
            lastAdWatchDate: null,
            referralCode: '',
            referredBy: null,
            referredUsers: {} 
        };
        let tronPriceUSD = 0.00;
        let trxPerAd = 0.00;
        let trxRefBonus = 0.00;
        let trxRefeeBonus = 0.00;

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const AD_FUNCTION_NAME = 'showAdexora'; 

        // DOM ELEMENTS
        const themeToggleBtn = document.getElementById('themeToggle');
        const profileNameDisplay = document.getElementById('profileNameDisplay');
        const profilePic = document.getElementById('profilePic');
        const userPointsDisplay = document.getElementById('userPointsDisplay');
        const adsWatchedTodayEl = document.getElementById('adsWatchedToday');
        const totalAdsWatchedEl = document.getElementById('totalAdsWatched');
        const adRewardValueEl = document.getElementById('adRewardValue');
        const tronPriceDisplay = document.getElementById('tronPriceDisplay');
        const mainContent = document.getElementById('mainContent');
        const bottomNavItems = document.querySelectorAll('.bottom-nav .nav-item');
        const adModal = document.getElementById('adModal');
        const adModalTitle = document.getElementById('adModalTitle');
        const adStatusMessage = document.getElementById('adStatusMessage');
        const adCloseBtn = document.getElementById('adCloseBtn');
        const toast = document.getElementById('toast');
        const adminNav = document.getElementById('adminNav');

        // UTILS
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        /**
         * Generates a unique and persistent referral code.
         * Confirms that the code is not already in use by another user in Firebase.
         * @returns {Promise<string>} 6-digit unique alphanumeric code.
         */
        async function generateUniqueReferralCode() {
            const usersRef = db.ref('users');
            let isUnique = false;
            let code = '';
            while (!isUnique) {
                // Generate 6-digit alphanumeric code
                code = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                
                // Check if this code exists in Firebase
                const snapshot = await usersRef.orderByChild('referralCode').equalTo(code).once('value');
                if (!snapshot.exists()) {
                    isUnique = true;
                }
            }
            return code;
        }
        
        function formatTRX(amount) {
            return parseFloat(amount).toFixed(4);
        }

        function escapeMarkdown(text) {
            // Escape characters required for Telegram MarkdownV2
            return String(text).replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$1');
        }

        // FIREBASE OPERATIONS
        function saveUserState() {
            if (!currentUser.telegramId) return;
            // Save balance with fixed precision
            currentUser.balanceTRX = parseFloat(currentUser.balanceTRX.toFixed(8)); 
            db.ref('users/' + currentUser.telegramId).set(currentUser)
                .catch(error => console.error("Error saving user to Firebase:", error));
        }

        function setInitialTRXValues() {
            // Price info is hardcoded as Google API cannot be called directly in the browser.
            tronPriceUSD = 0.06; // Default price (Approximate)
            trxPerAd = REWARD_USD_PER_AD / tronPriceUSD;
            trxRefBonus = REFERRAL_BONUS_USD_REFERRER / tronPriceUSD;
            trxRefeeBonus = REFERRAL_BONUS_USD_REFEREE / tronPriceUSD;

            tronPriceDisplay.textContent = `TRX/USD: $${tronPriceUSD.toFixed(5)} (Hardcoded)`;
            adRewardValueEl.textContent = `~${formatTRX(trxPerAd)} TRX`;
        }

        async function loadUserStateFromFirebase() {
            let initialRefCode = null;

            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user) {
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                currentUser.telegramId = tgUser.id;
                currentUser.name = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || `User${tgUser.id}`;
                currentUser.photoUrl = tgUser.photo_url || currentUser.photoUrl;

                // Get referral code from URL
                const urlParams = new URLSearchParams(window.location.search);
                initialRefCode = urlParams.get('start');
                if (initialRefCode && initialRefCode.includes('=')) {
                     initialRefCode = initialRefCode.split('=')[1];
                }

                const snapshot = await db.ref('users/' + currentUser.telegramId).once('value');
                const userData = snapshot.val();

                if (userData) {
                    Object.assign(currentUser, userData);
                    // Update Name/Photo from Telegram
                    currentUser.name = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || userData.name;
                    currentUser.photoUrl = tgUser.photo_url || userData.photoUrl;
                    
                    if (!currentUser.referredUsers) currentUser.referredUsers = {};
                    if (!currentUser.withdrawalRequests) currentUser.withdrawalRequests = {};

                    // If referral code doesn't exist, assign a permanent one.
                    if (!currentUser.referralCode) {
                        currentUser.referralCode = await generateUniqueReferralCode();
                    }
                    saveUserState(); 
                } else {
                    // New user
                    currentUser.balanceTRX = 0.00;
                    currentUser.referralCode = await generateUniqueReferralCode(); 
                    saveUserState(); 
                }
                
                // Show/hide Admin nav button
                if (currentUser.telegramId === ADMIN_TELEGRAM_ID) {
                    adminNav.style.display = 'flex';
                }

            } 
            
            // Daily counter reset
            const today = new Date().toLocaleDateString('en-CA');
            if (currentUser.lastAdWatchDate !== today) {
                currentUser.adsWatchedToday = 0;
                currentUser.lastAdWatchDate = today;
                saveUserState();
            }

            // Referral check (only if new user and code in URL)
            if (initialRefCode && !currentUser.referredBy && currentUser.referralCode && initialRefCode !== currentUser.referralCode) {
                applyReferral(initialRefCode);
            }
        }
        
        async function applyReferral(referrerCode) {
            if (!currentUser.telegramId || currentUser.referredBy || !currentUser.referralCode || referrerCode === currentUser.referralCode) return;

            const usersRef = db.ref('users');
            // Find the user who owns the referral code
            const referrerSnapshot = await usersRef.orderByChild('referralCode').equalTo(referrerCode).once('value');
            const referrerData = referrerSnapshot.val();

            if (referrerData) {
                const referrerId = Object.keys(referrerData)[0];
                const referrerUser = referrerData[referrerId];

                currentUser.balanceTRX += trxRefeeBonus;
                currentUser.referredBy = referrerCode;
                
                referrerUser.balanceTRX = (referrerUser.balanceTRX || 0) + trxRefBonus;
                referrerUser.referredUsers = referrerUser.referredUsers || {};
                referrerUser.referredUsers[currentUser.telegramId] = { 
                    name: currentUser.name, 
                    code: currentUser.referralCode 
                };
                
                await db.ref('users/' + currentUser.telegramId).update({ 
                    balanceTRX: parseFloat(currentUser.balanceTRX.toFixed(8)), 
                    referredBy: currentUser.referredBy 
                });
                await db.ref('users/' + referrerId).update({ 
                    balanceTRX: parseFloat(referrerUser.balanceTRX.toFixed(8)), 
                    referredUsers: referrerUser.referredUsers 
                });

                showToast(`Referral bonus: +${formatTRX(trxRefeeBonus)} TRX!`);
                sendTelegramReferralNotification(
                    currentUser.name, currentUser.telegramId, trxRefeeBonus, 
                    referrerUser.name, referrerId, trxRefBonus
                );
                updateUI();

            } else {
                showToast("Invalid referral code.");
            }
        }


        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                Telegram.WebApp.ready();
            }
            
            setInitialTRXValues(); 
            await loadUserStateFromFirebase();
            applyTheme(localStorage.getItem('tronAdsTheme') || 'light'); 
            
            // Initial load skips animation
            navigateTo('home', true);

            themeToggleBtn.addEventListener('click', toggleTheme);
            document.getElementById('editNameBtn').addEventListener('click', promptForNewName);
            bottomNavItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    // Navigation uses animation
                    navigateTo(page);
                });
            });
            adCloseBtn.addEventListener('click', closeAdModalAndReward);
        });

        // THEME MANAGEMENT
        function applyTheme(theme) {
            document.body.classList.toggle('dark-mode', theme === 'dark');
            themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('tronAdsTheme', theme);
        }

        function toggleTheme() {
            applyTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
        }

        // UI UPDATES
        function updateUI() {
            // Recreate and reattach event listener for the edit button
            profileNameDisplay.innerHTML = `
                ${currentUser.name}
                <i class="fas fa-check-circle verified-badge" style="color: var(--secondary-color); margin-left: 8px;"></i>
                <button class="edit-name-btn" id="editNameBtn">
                    <i class="fas fa-pencil-alt"></i>
                </button>
            `;
            document.getElementById('editNameBtn').addEventListener('click', promptForNewName);

            userPointsDisplay.innerHTML = `<i class="fas fa-wallet" style="margin-right: 8px; color: var(--primary-dark);"></i> ${formatTRX(currentUser.balanceTRX)} TRX`;
            adsWatchedTodayEl.textContent = currentUser.adsWatchedToday;
            totalAdsWatchedEl.textContent = currentUser.totalAdsWatchedLifetime;
            adRewardValueEl.textContent = `~${formatTRX(trxPerAd)} TRX`;

            if (currentUser.photoUrl) {
                profilePic.src = currentUser.photoUrl;
            }
        }

        function promptForNewName() {
            const newName = prompt("Enter your new name:", currentUser.name);
            if (newName && newName.trim()) {
                currentUser.name = newName.trim();
                updateUI();
                saveUserState();
                showToast("Name successfully updated!");
            }
        }

        // NAVIGATION 
        function navigateTo(page, isInitialLoad = false) {
            const currentActiveNavItem = document.querySelector('.bottom-nav .nav-item.active');
            if (currentActiveNavItem) {
                currentActiveNavItem.classList.remove('active');
            }
            const activeNavItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (activeNavItem) activeNavItem.classList.add('active');

            const pageRenderers = {
                'home': renderHomePage,
                'withdraw': renderWithdrawPage,
                'referral': renderReferralPage,
                'admin': renderAdminPage
            };
            
            // Function: Render content and fade in
            const renderAndFadeIn = () => {
                if (pageRenderers[page]) pageRenderers[page]();
                updateUI();
                
                void mainContent.offsetWidth; 
                mainContent.classList.add('active-content');
            };

            if (isInitialLoad) {
                // Initial load: render immediately
                renderAndFadeIn();
            } else {
                // Navigation: fade out current content
                mainContent.classList.remove('active-content');
                
                // Wait for the transition to finish (200ms) before rendering and showing new content
                setTimeout(() => {
                    renderAndFadeIn();
                }, 200); 
            }
        }

        // PAGE RENDERERS
        function renderHomePage() {
            mainContent.innerHTML = `
                <div class="task-card">
                    <h2 class="section-title">
                        <i class="fas fa-bullhorn"></i> Watch Ad & Earn
                    </h2>
                    <p class="task-description">
                        Earn **${formatTRX(trxPerAd)} TRX** (approx. $${REWARD_USD_PER_AD}) every time you watch a simple ad.
                    </p>
                    <div style="text-align: center; margin: 20px 0;">
                        <div class="reward-badge">Reward: ${formatTRX(trxPerAd)} TRX</div>
                    </div>
                    
                    <button class="btn btn-primary" id="watchDailyAdBtn">
                        <i class="fas fa-play-circle"></i> Watch Ad & Earn
                    </button>
                </div>`;
            document.getElementById('watchDailyAdBtn').addEventListener('click', handleWatchDailyAd);
        }

        function renderWithdrawPage() {
            mainContent.innerHTML = `
                <div class="task-card">
                    <h2 class="section-title">
                        <i class="fas fa-coins"></i> TRX Withdrawal Request
                    </h2>
                    <p class="task-description">
                        Current Balance: <b>${formatTRX(currentUser.balanceTRX)} TRX</b><br>
                        Minimum withdrawal amount: <b>${MIN_WITHDRAW_TRX.toFixed(2)} TRX</b> (TRON only)
                    </p>
                    <div class="input-group">
                        <label class="input-label">Amount to Withdraw (TRX)</label>
                        <input type="number" id="withdrawAmountInput" class="input-field" placeholder="At least ${MIN_WITHDRAW_TRX.toFixed(2)} TRX" value="">
                    </div>
                    <div class="input-group">
                        <label class="input-label">TRON (TRX) Wallet Address</label>
                        <input type="text" id="withdrawAccountInput" class="input-field" placeholder="Your wallet address starting with T">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Your Telegram Username (Required)</label>
                        <input type="text" id="withdrawUsernameInput" class="input-field" placeholder="@yourusername">
                    </div>
                    <button class="btn btn-primary" id="submitWithdrawBtn">
                        <i class="fas fa-paper-plane"></i> Submit Withdrawal Request
                    </button>
                    <p class="status-message" id="withdrawStatusMsg"></p>
                </div>`;
            document.getElementById('submitWithdrawBtn').addEventListener('click', handleSubmitWithdrawal);
        }

        function renderReferralPage() {
            const referralLink = `https://t.me/${TELEGRAM_BOT_USERNAME}?start=${currentUser.referralCode}`;
            const referredUsersCount = currentUser.referredUsers ? Object.keys(currentUser.referredUsers).length : 0;
            const refEarnedTRX = referredUsersCount * trxRefBonus;

            let referredUsersListHtml = '';
            if (referredUsersCount > 0) {
                referredUsersListHtml = `
                    <h3 style="margin: 25px 0 15px; font-size: 1.2rem; color: var(--primary-color);">Referred Users (${referredUsersCount})</h3>
                    <ul style="list-style: none; padding: 0;">`;
                
                Object.values(currentUser.referredUsers).forEach(refUser => {
                    referredUsersListHtml += `
                        <li style="padding: 10px; border-bottom: 1px dashed var(--border-color); display: flex; justify-content: space-between;">
                            <span><i class="fas fa-user-check" style="margin-right: 8px; color: var(--secondary-color);"></i> ${refUser.name || 'Unknown User'}</span>
                            <span style="font-weight: 600; color: var(--primary-color);">${refUser.code}</span>
                        </li>`;
                });
                referredUsersListHtml += `</ul>`;
            } else {
                referredUsersListHtml = `
                    <div style="text-align: center; padding: 20px 0; color: var(--text-secondary); opacity: 0.8; font-size: 0.95rem;">
                        <i class="fas fa-ghost" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>You haven't invited anyone yet. Share your link!</p>
                    </div>`;
            }

            mainContent.innerHTML = `
                <div class="task-card">
                    <h2 class="section-title">
                        <i class="fas fa-users-cog"></i> Referral System
                    </h2>
                    <p class="task-description">
                        Earn approximately <b>${formatTRX(trxRefBonus)} TRX</b> for every active user you invite. New users also start with a <b>${formatTRX(trxRefeeBonus)} TRX</b> bonus!
                    </p>
                    <div class="referral-container">
                        <label class="input-label">Your Permanent Referral Link</label>
                        <div class="referral-input-group">
                            <input type="text" id="referralLinkDisplay" class="referral-input" value="${referralLink}" readonly>
                            <button class="copy-btn" id="copyReferralLinkBtn"><i class="fas fa-copy"></i></button>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">**Link: https://t.me/${TELEGRAM_BOT_USERNAME}?start=${currentUser.referralCode}**</p>
                        
                        <div class="stats-display">
                            <div class="stat-item" style="text-align: center;">
                                <div class="stat-value" style="color: var(--secondary-color);">${referredUsersCount}</div>
                                <div class="stat-label">Total Referrals</div>
                            </div>
                            <div class="stat-item" style="text-align: center;">
                                <div class="stat-value">${formatTRX(refEarnedTRX)}</div>
                                <div class="stat-label">Referral TRX Earnings</div>
                            </div>
                        </div>

                        <button class="btn btn-secondary" id="shareReferralLinkBtn" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-share-alt"></i> Share Link on Telegram
                        </button>
                    </div>
                    ${referredUsersListHtml}
                </div>`;

            document.getElementById('copyReferralLinkBtn').addEventListener('click', () => {
                const referralLinkInput = document.getElementById('referralLinkDisplay');
                navigator.clipboard.writeText(referralLinkInput.value);
                showToast('Referral link copied!');
            });
            document.getElementById('shareReferralLinkBtn').addEventListener('click', () => {
                 if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(`Join this Tron Faucet and earn TRX by watching ads! Start now:`)}`);
                } else {
                    navigator.clipboard.writeText(referralLink);
                    showToast('Telegram WebApp not found, link copied!');
                }
            });
        }
        
        // ADMIN PAGE RENDERER
        function renderAdminPage() {
            if (currentUser.telegramId !== ADMIN_TELEGRAM_ID) {
                mainContent.innerHTML = `<div class="task-card error-message" style="text-align:center; padding: 20px; font-weight: bold;">Unauthorized Access!</div>`;
                return;
            }

            mainContent.innerHTML = `
                <h2 class="section-title"><i class="fas fa-user-lock"></i> Admin Panel</h2>
                <div class="task-card" id="adminStatsCard">Loading...</div>
                
                <h3 style="margin: 25px 0 15px; font-size: 1.2rem; color: var(--primary-color);">Pending Withdrawal Requests</h3>
                <ul class="admin-request-list" id="withdrawalRequestsList">
                    <li>Loading...</li>
                </ul>`;
            
            loadAdminData();
        }

        async function loadAdminData() {
            const statsCard = document.getElementById('adminStatsCard');
            const requestsList = document.getElementById('withdrawalRequestsList');
            
            // Load stats
            const usersSnapshot = await db.ref('users').once('value');
            const totalUsers = usersSnapshot.numChildren();
            let totalBalance = 0;
            let totalAds = 0;
            let totalReferrals = 0;
            
            usersSnapshot.forEach(userSnap => {
                const user = userSnap.val();
                totalBalance += user.balanceTRX || 0;
                totalAds += user.totalAdsWatchedLifetime || 0;
                totalReferrals += user.referredUsers ? Object.keys(user.referredUsers).length : 0;
            });

            statsCard.innerHTML = `
                <div class="admin-stat-card">
                    <b>Total Users:</b> ${totalUsers}
                </div>
                <div class="admin-stat-card">
                    <b>Total Balance (TRX):</b> ${formatTRX(totalBalance)}
                </div>
                <div class="admin-stat-card">
                    <b>Total Ads Watched:</b> ${totalAds}
                </div>
                <div class="admin-stat-card">
                    <b>Total Referrals:</b> ${totalReferrals}
                </div>
            `;
            
            // Load withdrawal requests
            const requestsSnapshot = await db.ref('withdrawalRequests').orderByChild('status').equalTo('Pending').once('value');
            const requestsData = requestsSnapshot.val();

            if (!requestsData) {
                requestsList.innerHTML = '<li style="text-align: center; padding: 10px; color: var(--text-secondary);">No pending withdrawal requests.</li>';
                return;
            }

            requestsList.innerHTML = '';
            Object.keys(requestsData).forEach(reqId => {
                const req = requestsData[reqId];
                const item = document.createElement('li');
                item.className = 'admin-request-item';
                item.innerHTML = `
                    <div class="request-detail" style="font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
                       <span>
                           <span style="font-weight: 700;">${formatTRX(req.amountTRX)} TRX</span> &rarr; 
                           <span style="font-family: monospace; font-size: 0.85rem;">${req.walletAddress.substring(0, 8)}...</span>
                       </span>
                       <button class="copy-wallet-btn" data-address="${req.walletAddress}" style="background: var(--primary-color); color: white; border: none; padding: 5px 8px; border-radius: var(--border-radius-sm); font-size: 0.75rem; cursor: pointer; transition: background 0.2s;"><i class="fas fa-copy"></i> Copy</button>
                    </div>
                    <div class="request-detail" style="font-size: 0.85rem; margin-top: 5px;">
                       üë§ ${req.userName} | ID: ${req.telegramId}
                    </div>
                    <div class="request-actions" style="margin-top: 10px; display: flex; justify-content: space-between;">
                        <button class="approve" data-id="${reqId}" data-user-id="${req.telegramId}" data-amount="${req.amountTRX}" style="flex: 1; margin-right: 5px;">Approve</button>
                        <button class="reject" data-id="${reqId}" data-user-id="${req.telegramId}" data-amount="${req.amountTRX}" style="flex: 1; margin-left: 5px;">Reject</button>
                    </div>
                `;
                requestsList.appendChild(item);
            });
            
            requestsList.querySelectorAll('.approve').forEach(btn => btn.addEventListener('click', handleAdminAction));
            requestsList.querySelectorAll('.reject').forEach(btn => btn.addEventListener('click', handleAdminAction));
            
            // YENƒ∞: Kopyalama butonu i≈ülevi
            requestsList.querySelectorAll('.copy-wallet-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const address = e.currentTarget.dataset.address;
                navigator.clipboard.writeText(address);
                showToast('TRX Address copied!');
            }));
        }

        async function handleAdminAction(event) {
            const btn = event.target;
            const reqId = btn.dataset.id;
            const userId = parseInt(btn.dataset.userId);
            const amountTRX = parseFloat(btn.dataset.amount);
            const action = btn.classList.contains('approve') ? 'Approved' : 'Rejected';

            if (!confirm(`Do you ${action === 'Approved' ? 'APPROVE' : 'REJECT'} the request for ${formatTRX(amountTRX)} TRX with ID ${reqId.substring(0, 8)}?`)) return;

            // Update request status
            await db.ref('withdrawalRequests/' + reqId).update({ status: action, adminId: currentUser.telegramId, resolutionTime: new Date().toISOString() });
            
            if (action === 'Rejected') {
                // Restore balance if rejected
                const userRef = db.ref('users/' + userId);
                const userSnap = await userRef.once('value');
                const user = userSnap.val();
                
                if (user) {
                    const newBalance = (user.balanceTRX || 0) + amountTRX;
                    await userRef.update({ balanceTRX: parseFloat(newBalance.toFixed(8)) });
                    showToast(`Rejected. Balance restored: +${formatTRX(amountTRX)} TRX`, 5000);
                }
            } else {
                 showToast(`Request Approved. Please make the payment.`, 5000);
            }
            
            loadAdminData(); // G√úNCELLENDƒ∞: Admin paneli verilerini yenile
        }


        // AD HANDLING
        function handleWatchDailyAd() {
            openAdModal("Ad Starting...");
            adModalTitle.textContent = "Ad Starting...";
            adStatusMessage.textContent = "Please wait...";
            adCloseBtn.style.display = 'none';

            if (window[AD_FUNCTION_NAME] && typeof window[AD_FUNCTION_NAME] === 'function') {
                window[AD_FUNCTION_NAME]()
                    .then(() => {
                        // Success (Ad Watch Completed)
                        adModalTitle.textContent = "Congratulations! üéâ";
                        adStatusMessage.textContent = `Ad completed successfully. Press the button to earn ${formatTRX(trxPerAd)} TRX.`;
                        adCloseBtn.style.display = 'block';
                        adCloseBtn.textContent = "Close & Claim Reward";
                        adCloseBtn.dataset.rewardStatus = 'success';
                    })
                    .catch(e => {
                        // Error (User Closed/Error Occurred)
                        console.error("Adexora Ad Error:", e);
                        adModalTitle.textContent = "Transaction Failed ‚ùå";
                        adStatusMessage.textContent = "You didn't watch the ad completely or an error occurred. Reward not granted.";
                        adCloseBtn.style.display = 'block';
                        adCloseBtn.textContent = "Close";
                        adCloseBtn.dataset.rewardStatus = 'fail';
                    });
            } else {
                // Simulation
                showToast("Adexora code not found. Starting 5 sec simulation.");
                adModalTitle.textContent = "Ad Simulation ‚è±Ô∏è";
                adStatusMessage.textContent = "Simulation in progress... (5 sec)";
                setTimeout(() => {
                    adModalTitle.textContent = "Simulation Completed! üéâ";
                    adStatusMessage.textContent = `Simulation successful. Close to earn ${formatTRX(trxPerAd)} TRX.`;
                    adCloseBtn.style.display = 'block';
                    adCloseBtn.textContent = "Close & Claim Reward";
                    adCloseBtn.dataset.rewardStatus = 'success';
                }, 5000);
            }
        }

        function openAdModal(title) {
            adModalTitle.textContent = title;
            adCloseBtn.style.display = 'none';
            adModal.style.opacity = '1';
            adModal.style.pointerEvents = 'all';
        }

        function closeAdModalAndReward() {
            adModal.style.opacity = '0';
            adModal.style.pointerEvents = 'none';
            const rewardStatus = adCloseBtn.dataset.rewardStatus;
            
            if (rewardStatus === 'success') {
                // Grant reward and update counters
                currentUser.balanceTRX += trxPerAd;
                currentUser.adsWatchedToday++;
                currentUser.totalAdsWatchedLifetime++;
                currentUser.lastAdWatchDate = new Date().toLocaleDateString('en-CA');

                updateUI();
                saveUserState();
                showToast(`+${formatTRX(trxPerAd)} TRX earned!`);
            } else if (rewardStatus === 'fail') {
                showToast("Ad reward not granted.");
            }
            adCloseBtn.dataset.rewardStatus = '';
        }

        // WITHDRAWAL HANDLING
        async function handleSubmitWithdrawal() {
            if (!currentUser.telegramId) {
                showToast("You must be a Telegram user to make a withdrawal request.");
                return;
            }
            
            const amount = parseFloat(document.getElementById('withdrawAmountInput').value);
            const walletAddress = document.getElementById('withdrawAccountInput').value.trim();
            const telegramUsername = document.getElementById('withdrawUsernameInput').value.trim();
            const statusMsg = document.getElementById('withdrawStatusMsg');

            statusMsg.className = 'status-message';
            statusMsg.textContent = '';

            if (isNaN(amount) || amount <= 0 || amount > 1000000) {
                statusMsg.textContent = "Please enter a valid amount.";
                statusMsg.classList.add('error-message');
                return;
            }
            if (amount < MIN_WITHDRAW_TRX) { // G√úNCELLENDƒ∞: Min √ßekim kontrol√º
                statusMsg.textContent = `The minimum withdrawal is ${MIN_WITHDRAW_TRX.toFixed(2)} TRX.`;
                statusMsg.classList.add('error-message');
                return;
            }
            if (amount > currentUser.balanceTRX) {
                statusMsg.textContent = "Insufficient balance.";
                statusMsg.classList.add('error-message');
                return;
            }
            if (!walletAddress || !walletAddress.startsWith('T') || walletAddress.length < 30) {
                statusMsg.textContent = "Please enter a valid TRON (TRX) wallet address (must start with T).";
                statusMsg.classList.add('error-message');
                return;
            }
            if (!telegramUsername || !telegramUsername.startsWith('@') || telegramUsername.length < 4) {
                statusMsg.textContent = "Please enter a valid Telegram Username (must start with @).";
                statusMsg.classList.add('error-message');
                return;
            }

            // Deduct from balance
            currentUser.balanceTRX -= amount;
            
            // Save withdrawal request to Firebase
            const withdrawalRequest = {
                telegramId: currentUser.telegramId,
                userName: currentUser.name,
                telegramUsername: telegramUsername,
                amountTRX: amount,
                walletAddress: walletAddress,
                status: 'Pending', 
                timestamp: new Date().toISOString()
            };

            await db.ref('withdrawalRequests').push(withdrawalRequest);

            // Send Notification to Telegram Admin Channel
            sendTelegramWithdrawalNotification(withdrawalRequest);

            updateUI();
            saveUserState();

            statusMsg.textContent = "Your withdrawal request has been successfully submitted and is under review!";
            statusMsg.classList.add('success-message');
            document.getElementById('withdrawAmountInput').value = "";
            document.getElementById('withdrawAccountInput').value = "";
            document.getElementById('withdrawUsernameInput').value = "";
        }

        // TELEGRAM NOTIFICATIONS
        function sendToTelegram(message) {
            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                console.warn("Telegram Bot settings are missing. Notification failed to send.");
                return;
            }

            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: message,
                    parse_mode: 'MarkdownV2'
                })
            })
            .catch(error => console.error('Error sending Telegram message:', error));
        }

        function sendTelegramWithdrawalNotification(req) {
            const message = "üö® *NEW WITHDRAWAL REQUEST* üö®\n" +
                "------------------------------------\n" +
                // User Name with clickable link (tg://user?id=)
                "üë§ *User:* \\[\`" + escapeMarkdown(req.userName) + "\`\\](tg://user?id=" + req.telegramId + ")\n" +
                "üÜî *Telegram ID:* `" + req.telegramId + "`\n" +
                "üí∞ *Amount:* " + formatTRX(req.amountTRX) + " TRX\n" +
                "üí≥ *Wallet:* `" + escapeMarkdown(req.walletAddress) + "`\n" +
                "üì± *Username:* `" + escapeMarkdown(req.telegramUsername) + "`\n" +
                "------------------------------------\n" +
                "‚è∞ *Request Time:* " + new Date(req.timestamp).toLocaleString('en-US');
            sendToTelegram(message);
        }

        function sendTelegramReferralNotification(refereeName, refereeId, refereeBonus, referrerName, referrerId, referrerBonus) {
            const message = "üéâ *NEW REFERRAL* üéâ\n" +
                "------------------------------------\n" +
                // New User (Referee)
                "üë• *New User:* \\[\`" + escapeMarkdown(refereeName) + "\`\\](tg://user?id=" + refereeId + ")\n" +
                "üåü *Earned:* " + formatTRX(refereeBonus) + " TRX\n" +
                "Inviter:\n" +
                // Inviter (Referrer)
                "üë§ *Inviter:* \\[\`" + escapeMarkdown(referrerName) + "\`\\](tg://user?id=" + referrerId + ")\n" +
                "üåü *Earned:* " + formatTRX(referrerBonus) + " TRX\n" +
                "------------------------------------\n" +
                "‚è∞ *Time:* " + new Date().toLocaleString('en-US');
            sendToTelegram(message);
        }

    </script>
</body>
</html>
