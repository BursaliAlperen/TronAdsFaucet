<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tron Ads Faucet</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <style>
        /* CSS Variables and Styles remain the same */
        /* Google Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        /* CSS Variables for Theming (RED/WHITE) */
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color-light: #f4f4f9; 
            --secondary-bg-light: #ffffff; 
            --text-color-light: #1c1c1e;
            --subtle-text-light: #6d6d72;
            --primary-color-light: #dc3545; /* Red */
            --border-color-light: #e0e0e0;
            --bg-color-dark: #121212;
            --secondary-bg-dark: #1c1c1e;
            --text-color-dark: #ffffff;
            --subtle-text-dark: #8e8e93;
            --primary-color-dark: #ff4d4d; 
            --border-color-dark: #38383a;
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Theme Styles */
        body.light-theme { background-color: var(--bg-color-light); color: var(--text-color-light); }
        body.dark-theme { background-color: var(--bg-color-dark); color: var(--text-color-dark); }
        #app { max-width: 500px; margin: 0 auto; padding-bottom: 70px; } 

        /* Profile Header */
        .profile-header { padding: 20px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid; }
        .light-theme .profile-header { border-bottom-color: var(--border-color-light); }
        .dark-theme .profile-header { border-bottom-color: var(--border-color-dark); }
        .profile-info { display: flex; align-items: center; gap: 15px; }
        #user-photo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid; }
        .light-theme #user-photo { border-color: var(--primary-color-light); }
        .dark-theme #user-photo { border-color: var(--primary-color-dark); }
        .user-details h1 { font-size: 1.2rem; font-weight: 700; }
        .verified-icon { font-size: 1rem; margin-left: 5px; }
        .light-theme .verified-icon { color: var(--primary-color-light); }
        .dark-theme .verified-icon { color: var(--primary-color-dark); }
        .user-details p { font-size: 0.9rem; font-weight: 600; }
        .light-theme .user-details p { color: var(--subtle-text-light); }
        .dark-theme .user-details p { color: var(--subtle-text-dark); }
        #admin-btn { background: #dc3545; color: white; padding: 8px 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.8rem; }


        /* Main Content & Pages */
        main { padding: 15px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.5rem; margin-bottom: 15px; }

        /* Home Page Stats & Referral */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .stat-card { padding: 15px 10px; border-radius: 12px; text-align: center; }
        .light-theme .stat-card { background-color: var(--secondary-bg-light); border: 1px solid var(--border-color-light); }
        .dark-theme .stat-card { background-color: var(--secondary-bg-dark); border: 1px solid var(--border-color-dark); }
        .stat-card h3 { font-size: 0.8rem; margin-bottom: 5px; }
        .light-theme .stat-card h3 { color: var(--subtle-text-light); }
        .dark-theme .stat-card h3 { color: var(--subtle-text-dark); }
        .stat-card p { font-size: 1.1rem; font-weight: 700; word-break: break-all; }
        .light-theme .stat-card p { color: var(--primary-color-light); }
        .dark-theme .stat-card p { color: var(--primary-color-dark); }
        .price-text { font-size: 0.9rem !important; }

        /* Referral Section (Friends Page) */
        .referral-section { margin-top: 30px; padding: 20px; border-radius: 12px; text-align: center; }
        .light-theme .referral-section { background-color: var(--secondary-bg-light); border: 1px solid var(--border-color-light); }
        .dark-theme .referral-section { background-color: var(--secondary-bg-dark); border: 1px solid var(--border-color-dark); }
        .referral-section h3 { text-align: center; }
        
        /* Task Container */
        .task-container { padding: 20px; border-radius: 12px; text-align: center; margin-top: 30px; }
        .light-theme .task-container { background-color: var(--secondary-bg-light); border: 1px solid var(--border-color-light); }
        .dark-theme .task-container { background-color: var(--secondary-bg-dark); border: 1px solid var(--border-color-dark); }
        .task-icon { font-size: 3rem; margin-bottom: 15px; }
        .light-theme .task-icon { color: var(--primary-color-light); }
        .dark-theme .task-icon { color: var(--primary-color-dark); }
        .task-container h3 { font-size: 1.2rem; margin-bottom: 5px; }
        .task-container p { font-size: 0.9rem; margin-bottom: 15px; }
        .light-theme .task-container p { color: var(--subtle-text-light); }
        .dark-theme .task-container p { color: var(--subtle-text-dark); }

        /* Action Button */
        .action-btn { width: 100%; padding: 15px; font-size: 1rem; font-weight: 700; color: #fff; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; position: relative; display: flex; justify-content: center; align-items: center; }
        .light-theme .action-btn { background-color: var(--primary-color-light); }
        .dark-theme .action-btn { background-color: var(--primary-color-dark); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-loader { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        .action-btn.loading .btn-text { visibility: hidden; }
        .action-btn.loading .btn-loader { display: block; position: absolute; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .input-group input, .input-group button, .form-group input, .form-group select { padding: 12px; border-radius: 8px; font-family: var(--font-family); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-group { display: flex; }
        .input-group input { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-group button { background-color: var(--primary-color-light); color: #fff; border: none; font-weight: 600; border-top-left-radius: 0; border-bottom-left-radius: 0; padding: 12px 15px; }
        .manual-input-group { display: flex; gap: 5px; margin-bottom: 5px;}
        .manual-input-group input { padding: 8px; font-size: 0.9rem; }
        .manual-input-group button { padding: 8px 10px; font-size: 0.9rem; }

        .light-theme input, .light-theme select { background-color: var(--bg-color-light); border: 1px solid var(--border-color-light); color: var(--text-color-light); }
        .dark-theme input, .dark-theme select { background-color: var(--secondary-bg-dark); border: 1px solid var(--border-color-dark); color: var(--text-color-dark); }
        .light-theme input:focus, .light-theme select:focus { outline: none; border-color: var(--primary-color-light); box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15); }
        .dark-theme input:focus, .dark-theme select:focus { outline: none; border-color: var(--primary-color-dark); box-shadow: 0 0 0 3px rgba(255, 77, 77, 0.2); }
        
        /* Admin Table Styles */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        .admin-table th, .admin-table td { padding: 10px; text-align: left; border-bottom: 1px solid; }
        .light-theme .admin-table th, .light-theme .admin-table td { border-bottom-color: var(--border-color-light); }
        .dark-theme .admin-table th, .dark-theme .admin-table td { border-bottom-color: var(--border-color-dark); }
        .admin-table th { background-color: var(--primary-color-light); color: white; font-weight: 700; }
        .admin-table tr:nth-child(even) { background-color: rgba(220, 53, 69, 0.05); } 
        .admin-table td code { font-size: 0.75rem; }
        
        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid; z-index: 1000; }
        .light-theme .bottom-nav { background-color: var(--secondary-bg-light); border-top-color: var(--border-color-light); }
        .dark-theme .bottom-nav { background-color: var(--secondary-bg-dark); border-top-color: var(--border-color-dark); }
        .nav-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; padding: 5px 10px; font-family: var(--font-family); font-size: 0.7rem; transition: color 0.2s; flex-grow: 1; }
        .light-theme .nav-btn { color: var(--subtle-text-light); }
        .dark-theme .nav-btn { color: var(--subtle-text-dark); }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 3px; }
        .nav-btn.active { font-weight: 700; }
        .light-theme .nav-btn.active { color: var(--primary-color-light); }
        .dark-theme .nav-btn.active { color: var(--primary-color-dark); }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; }
        .modal-content { padding: 30px; border-radius: 15px; text-align: center; }
        .light-theme .modal-content { background-color: var(--secondary-bg-light); }
        .dark-theme .modal-content { background-color: var(--secondary-bg-dark); }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        .light-theme .loader { border-top-color: var(--primary-color-light); }
        .dark-theme .loader { border-top-color: var(--primary-color-dark); }
    </style>
</head>
<body class="light-theme">

    <div id="app">
        <header class="profile-header">
            <div class="profile-info">
                <img id="user-photo" src="" alt="User Photo">
                <div class="user-details">
                    <h1 id="user-name">Loading... <i class="fas fa-check-circle verified-icon"></i></h1>
                    <p> Balance: <span id="user-points">0.0000</span> TRX</p>
                </div>
            </div>
            <button id="admin-btn" style="display: none;">Admin Panel</button>
        </header>

        <main id="main-content">
            <div id="home-page" class="page active">
                <h2>Dashboard & Task</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Daily Ads Watched</h3>
                        <p><span id="daily-ads-watched">00</span> /  100</p>
                    </div>
                    <div class="stat-card">
                        <h3>TRX/USD Price</h3>
                        <p id="trx-price-display" class="price-text">Loading...</p>
                    </div>
                    <div class="stat-card">
                        <h3>Ad Reward (TRX)</h3>
                        <p id="ad-reward-trx">0.0000</p>
                    </div>
                </div>

                <div class="task-container">
                    <i class="fas fa-video task-icon"></i>
                    <h3>Watch a Rewarded Ad</h3>
                    <p>Earn **$0.001** worth of TRX for every ad.</p> 
                    <button id="watch-ad-btn" class="action-btn">Watch Ad</button>
                </div>
            </div>

            <div id="withdraw-page" class="page">
                <h2>Withdraw</h2>
                <p>Minimum **0.01 TRX** required to withdraw.</p>
                <form id="withdraw-form">
                    <div class="form-group">
                        <label for="withdraw-method">Method:</label>
                        <input type="text" id="withdraw-method-display" value="Tron (TRX)" readonly style="text-align: center; font-weight: bold; margin-bottom: 10px;">
                    </div>
                    <div class="form-group">
                        <label for="account-number">TRON Wallet Address:</label>
                        <input type="text" id="account-number" placeholder="T..." required>
                    </div>
                    <div class="form-group">
                        <label for="amount">TRX to Withdraw:</label>
                        <input type="number" id="amount" placeholder="e.g., 0.01" required step="0.0001">
                    </div>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn">
                        <span class="btn-text">Submit Request</span>
                        <span class="btn-loader"></span>
                    </button>
                </form>
            </div>

            <div id="friends-page" class="page">
                <h2>Invite Friends & Earn</h2>
                <div class="referral-section">
                    <h3>Referral Code</h3>
                    <p>
                        **Earnings of $0.02** worth of TRX per referral.
                    </p>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="my-ref-id-display">Your Referral ID (Share this!)</label>
                        <div class="input-group">
                            <input type="text" id="my-ref-id-display" value="Loading..." readonly>
                            <button type="button" id="copy-ref-id-btn">Copy ID</button>
                        </div>
                    </div>

                    <div class="form-group" id="ref-code-input-group">
                        <label for="ref-code-input">Enter Friend's Referral Code & Get Reward! ✨</label>
                        <div class="input-group">
                            <input type="text" id="ref-code-input" placeholder="Friend's User ID">
                            <button type="button" id="submit-ref-code-btn">Apply</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3>Share Bot Link</h3>
                        <p>Share the official bot link with your unique referral ID to let your friends join and earn!</p>
                        <button id="copy-ref-link-btn" class="action-btn" style="margin-top: 15px;">
                            <i class="fas fa-share-alt"></i> Share Bot Link
                        </button>
                    </div>
                    
                    <div class="stat-card" style="margin-top: 20px;">
                        <h3>Total Referrals</h3>
                        <p id="referral-count">00</p>
                    </div>
                </div>
            </div>

            <div id="admin-page" class="page">
                <h2>Admin Dashboard</h2>
                <div class="stats-grid" style="grid-template-columns: 1fr;">
                    <div class="stat-card">
                        <h3>Total Users (Firebase)</h3> 
                        <p id="total-users-count">...</p>
                    </div>
                </div>

                <div class="referral-section" style="margin-top: 20px;">
                    <h3>Pending Withdrawal Requests (Realtime)</h3>
                    
                    <button type="button" id="clear-requests-btn" class="action-btn" style="background-color: #6c757d; margin-top: 10px; padding: 10px; font-size: 0.9rem;">Clear All Requests (DONE)</button>
                    
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>User ID/Name</th>
                                    <th>Amount (TRX)</th>
                                    <th>Address</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawal-requests-table">
                                <tr><td colspan="4" style="text-align: center; color: var(--subtle-text-light);">Loading requests...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
            <button class="nav-btn" data-page="friends-page"><i class="fas fa-user-friends"></i><span>Friends</span></button>
            <button class="nav-btn" data-page="admin-page" id="nav-admin-btn" style="display: none;"><i class="fas fa-user-shield"></i><span>Admin</span></button>
        </nav>
    </div>

    <div id="loading-modal" class="modal">
        <div class="modal-content"><div class="loader"></div><p>Loading Ad...</p></div>
    </div>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adexora.com/cdn/ads.js?id=494"></script>
    
    <script>
        // *** FIREBASE CONFIGURATION START ***
        const firebaseConfig = {
          apiKey: "AIzaSyCGGHZROaP3RkFs-a293uTFaWn521y3BeM",
          authDomain: "tronadsfaucet.firebaseapp.com",
          projectId: "tronadsfaucet",
          storageBucket: "tronadsfaucet.firebasestorage.app",
          messagingSenderId: "26180984735",
          appId: "1:26180984735:web:e498a635c4f61bd0a167aa"
          // Realtime Database URL ve Measurement ID bu uygulamada Firestore kullandığı için çıkarılmıştır.
        };

        // Firebase'i başlat
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        // Firestore'u kullanıma hazırla
        const db = firebase.firestore();
        // *** FIREBASE CONFIGURATION END ***

        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;

            // --- Configuration ---
            const BOT_TOKEN = "8440148461:AAGDh6aXDswlpR1ug_Cx9JAnOGKnmvH8h_4";
            const BOT_USERNAME = "TronAdsFaucetBot"; 
            const ADMIN_CHAT_ID = "7904032877";
            
            const DAILY_AD_LIMIT = 100; 
            const USD_PER_AD = 0.001; 
            const USD_PER_REFERRAL_BONUS = 0.02; 
            const MIN_WITHDRAW_POINTS = 0.01; 
            let TRX_TO_USD_RATE = 0.342249; 

            // Calculated TRX Amounts
            let TRX_PER_AD = (USD_PER_AD / TRX_TO_USD_RATE); 
            let TRX_PER_REFERRAL_BONUS = (USD_PER_REFERRAL_BONUS / TRX_TO_USD_RATE);
            
            // --- DOM Elements ---
            const userPointsElem = document.getElementById('user-points');
            const dailyAdsWatchedElem = document.getElementById('daily-ads-watched');
            const trxPriceDisplayElem = document.getElementById('trx-price-display');
            const adRewardTrxElem = document.getElementById('ad-reward-trx');
            const referralCountElem = document.getElementById('referral-count');
            
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const withdrawForm = document.getElementById('withdraw-form');
            const withdrawSubmitBtn = document.getElementById('withdraw-submit-btn');
            const copyRefLinkBtn = document.getElementById('copy-ref-link-btn');
            const loadingModal = document.getElementById('loading-modal');

            // REFERRAL ELEMENTS
            const refCodeInputGroup = document.getElementById('ref-code-input-group');
            const refCodeInput = document.getElementById('ref-code-input');
            const submitRefCodeBtn = document.getElementById('submit-ref-code-btn');
            const myRefIdDisplay = document.getElementById('my-ref-id-display');
            const copyRefIdBtn = document.getElementById('copy-ref-id-btn');
            
            // ADMIN PANEL ELEMENTS
            const adminBtn = document.getElementById('admin-btn');
            const navAdminBtn = document.getElementById('nav-admin-btn');
            const totalUsersCountElem = document.getElementById('total-users-count');
            const withdrawalRequestsTable = document.getElementById('withdrawal-requests-table');
            const clearRequestsBtn = document.getElementById('clear-requests-btn');

            // --- State Management (Now Firestore based) ---
            let userState = {
                trxBalance: 0.0000, 
                dailyAdWatchCount: 0,
                lastAdWatchDate: null,
                referrals: [],
                referredBy: null, 
                userId: null,
                name: null, 
                username: null
            };

            const userDocRef = (userId) => db.collection('users').doc(String(userId));
            const requestsCollection = db.collection('withdrawal_requests');
            
            // --- Core Functions ---
            const initApp = () => {
                tg.ready();
                tg.expand();
                document.body.className = `${tg.colorScheme}-theme`;

                const user = tg.initDataUnsafe.user;
                if (!user || !user.id) {
                    tg.showAlert("User could not be verified. Please open this application through Telegram.", () => tg.close());
                    return;
                }
                
                userState.userId = user.id;
                userState.name = `${user.first_name || ''} ${user.last_name || ''}`;
                userState.username = user.username || null;

                // Load and listen for user data in real-time
                userDocRef(user.id).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // Merge current state with Firebase data
                        userState = { ...userState, ...data };
                        userState.trxBalance = parseFloat(userState.trxBalance) || 0;

                        // Check daily reset
                        const today = new Date().toISOString().slice(0, 10);
                        if (userState.lastAdWatchDate !== today) {
                            userState.dailyAdWatchCount = 0;
                            userState.lastAdWatchDate = today;
                            saveState(); // Update Firebase with reset counts
                        }
                        
                        updateUI();
                        
                    } else {
                        // New user: Create initial document
                        saveState(true);
                    }
                }, error => {
                    tg.showAlert("Veri yüklenemedi. Firebase bağlantı hatası: " + error.message);
                });
                
                // ADMIN CHECK
                if (String(userState.userId) === ADMIN_CHAT_ID) {
                    document.getElementById('admin-btn').style.display = 'block';
                    navAdminBtn.style.display = 'flex';
                }

                setupNavigation();
                setupEventListeners();
            };
            
            // Replaces saveState, now writes to Firebase
            const saveState = async (isNewUser = false) => {
                if(!userState.userId) return;
                
                const dataToSave = {
                    trxBalance: parseFloat(userState.trxBalance).toFixed(4), 
                    dailyAdWatchCount: userState.dailyAdWatchCount,
                    lastAdWatchDate: userState.lastAdWatchDate,
                    referrals: userState.referrals || [],
                    referredBy: userState.referredBy || null, 
                };

                // Only write metadata on creation or if explicitly needed
                if (isNewUser) {
                    dataToSave.name = userState.name;
                    dataToSave.username = userState.username;
                    dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                }

                try {
                    await userDocRef(userState.userId).set(dataToSave, { merge: true });
                } catch (error) {
                    console.error("Error saving state to Firebase:", error);
                    tg.showAlert("Hata: Veri kaydı yapılamadı. Tekrar deneyin.");
                }
            };

            const updateUI = () => {
                const user = tg.initDataUnsafe.user;
                
                document.getElementById('user-photo').src = user.photo_url || 'https://i.imgur.com/placeholder.png';
                document.getElementById('user-name').innerHTML = `${user.first_name || ''} ${user.last_name || ''} <i class="fas fa-check-circle verified-icon"></i>`;
                
                userPointsElem.textContent = parseFloat(userState.trxBalance).toFixed(4); 
                dailyAdsWatchedElem.textContent = userState.dailyAdWatchCount;
                referralCountElem.textContent = (userState.referrals || []).length;

                trxPriceDisplayElem.textContent = `$${TRX_TO_USD_RATE.toFixed(4)}`;
                adRewardTrxElem.textContent = TRX_PER_AD.toFixed(6); 
                
                if (myRefIdDisplay) {
                    myRefIdDisplay.value = userState.userId;
                }

                // Check Referral Code Entry Field
                if (userState.referredBy) {
                    refCodeInputGroup.innerHTML = `<p style="color: var(--primary-color-light); font-weight: 700;">✅ Referral code successfully used! (${userState.referredBy})</p>`;
                } else {
                    // Reset if referredBy is cleared/not set
                    if (!document.getElementById('ref-code-input')) {
                         refCodeInputGroup.innerHTML = `
                            <label for="ref-code-input">Enter Friend's Referral Code & Get Reward! ✨</label>
                            <div class="input-group">
                                <input type="text" id="ref-code-input" placeholder="Friend's User ID">
                                <button type="button" id="submit-ref-code-btn">Apply</button>
                            </div>
                        `;
                        document.getElementById('submit-ref-code-btn').addEventListener('click', handleEnterReferralCode);
                    }
                }
            };
            
            const handleCopyRefId = () => {
                const refId = userState.userId;
                navigator.clipboard.writeText(refId).then(() => {
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("Your Referral ID copied to clipboard!");
                });
            };
            
            const setupEventListeners = () => {
                watchAdBtn.addEventListener('click', handleWatchAd);
                withdrawForm.addEventListener('submit', handleWithdraw);
                copyRefLinkBtn.addEventListener('click', copyReferralLink);
                
                // İlk başta var olup olmadığını kontrol et
                const initialSubmitRefCodeBtn = document.getElementById('submit-ref-code-btn');
                if (initialSubmitRefCodeBtn) {
                     initialSubmitRefCodeBtn.addEventListener('click', handleEnterReferralCode);
                }
                
                copyRefIdBtn.addEventListener('click', handleCopyRefId); 

                adminBtn.addEventListener('click', () => {
                     document.querySelector('.page.active').classList.remove('active');
                     document.getElementById('admin-page').classList.add('active');
                     document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                     navAdminBtn.classList.add('active');
                     loadAdminStats(); // Start listener
                });
                
                if (clearRequestsBtn) clearRequestsBtn.addEventListener('click', handleClearRequests);
            };

            const handleWatchAd = async () => {
                if (userState.dailyAdWatchCount >= DAILY_AD_LIMIT) {
                    tg.showAlert("You have reached the daily ad watch limit."); return;
                }
                loadingModal.style.display = 'flex';
                
                if(typeof window.showAdexora === 'function') {
                    window.showAdexora()
                    .then(async () => {
                        // Use a transaction for safe update
                        await db.runTransaction(async (transaction) => {
                            const userDoc = await transaction.get(userDocRef(userState.userId));
                            if (!userDoc.exists) { throw "User document does not exist!"; }
                            
                            const currentData = userDoc.data();
                            const newBalance = parseFloat(currentData.trxBalance) + TRX_PER_AD;
                            const newAdCount = currentData.dailyAdWatchCount + 1;
                            
                            transaction.update(userDocRef(userState.userId), { 
                                trxBalance: newBalance.toFixed(4), 
                                dailyAdWatchCount: newAdCount 
                            });
                        });

                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Congratulations! You earned ${TRX_PER_AD.toFixed(6)} TRX ( $${USD_PER_AD} ).`);
                    })
                    .catch(e => {
                        console.error(e);
                        tg.showAlert("Ad failed to load or a transaction error occurred. Please try again.");
                    })
                    .finally(() => {
                        loadingModal.style.display = 'none';
                    });
                } else {
                    // Fallback (Should be removed once adexora is stable)
                    setTimeout(async () => {
                        try {
                            await db.runTransaction(async (transaction) => {
                                const userDoc = await transaction.get(userDocRef(userState.userId));
                                const currentData = userDoc.data();
                                const newBalance = parseFloat(currentData.trxBalance) + TRX_PER_AD;
                                const newAdCount = currentData.dailyAdWatchCount + 1;
                                transaction.update(userDocRef(userState.userId), { 
                                    trxBalance: newBalance.toFixed(4), 
                                    dailyAdWatchCount: newAdCount 
                                });
                            });
                            tg.HapticFeedback.notificationOccurred('success');
                            tg.showAlert(`Congratulations! You earned ${TRX_PER_AD.toFixed(6)} TRX ( $${USD_PER_AD} ) (Adexora failed to load - fallback used).`);
                        } catch(e) {
                             tg.showAlert("Fallback ad error: " + e.message);
                        }
                        loadingModal.style.display = 'none';
                    }, 1000);
                }
            };

            const handleEnterReferralCode = async () => {
                if (userState.referredBy) {
                    tg.showAlert("Your referral code has already been used.");
                    return;
                }
                
                const refCode = refCodeInput.value.trim();
                const refId = String(parseInt(refCode));

                if (!refCode || isNaN(refId)) { tg.showAlert("Please enter a valid Referral Code (User ID)."); return; }
                if (refId === String(userState.userId)) { tg.showAlert("You cannot use your own code."); return; }

                submitRefCodeBtn.disabled = true;

                try {
                    await db.runTransaction(async (transaction) => {
                        const referrerDoc = await transaction.get(userDocRef(refId));
                        const referredDoc = await transaction.get(userDocRef(userState.userId));
                        
                        if (!referrerDoc.exists) { throw new Error("The referral code is invalid or the user was not found."); }
                        if (referredDoc.data().referredBy) { throw new Error("User already used a referral code."); }

                        // 1. Update Referred User (Current User)
                        const currentBalance = parseFloat(referredDoc.data().trxBalance);
                        const newBalance = currentBalance + TRX_PER_REFERRAL_BONUS;
                        transaction.update(userDocRef(userState.userId), { 
                            referredBy: refId, 
                            trxBalance: newBalance.toFixed(4)
                        });

                        // 2. Update Referrer User
                        const referrerData = referrerDoc.data();
                        // ensure referrals is an array before spread
                        const existingReferrals = Array.isArray(referrerData.referrals) ? referrerData.referrals : [];
                        const newReferrals = [...existingReferrals, userState.userId];
                        transaction.update(userDocRef(refId), { 
                            referrals: newReferrals 
                        });
                    });

                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert(`Congratulations! Referral code applied and you earned ${TRX_PER_REFERRAL_BONUS.toFixed(4)} TRX!`);

                } catch (error) {
                    console.error("Referral Transaction Error:", error);
                    tg.showAlert(error.message || "An error occurred during referral processing. Please check the code.");
                } finally {
                    submitRefCodeBtn.disabled = false;
                }
            };
            
            const handleWithdraw = async (e) => {
                e.preventDefault();
                const accountNumber = document.getElementById('account-number').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);

                if (isNaN(amount) || amount <= 0) { tg.showAlert("Please enter a valid amount."); return; }
                if (amount < MIN_WITHDRAW_POINTS) { tg.showAlert(`Minimum withdrawal is ${MIN_WITHDRAW_POINTS.toFixed(2)} TRX.`); return; }
                if (amount > userState.trxBalance) { tg.showAlert("Your balance is insufficient."); return; }

                withdrawSubmitBtn.classList.add('loading');
                withdrawSubmitBtn.disabled = true;
                
                let balanceDeducted = false;
                
                try {
                    // 1. Safely deduct from balance and add request to Firebase in one transaction
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userDocRef(userState.userId));
                        if (!userDoc.exists) { throw new Error("User not found."); }
                        
                        const currentBalance = parseFloat(userDoc.data().trxBalance);
                        if (currentBalance < amount) { throw new Error("Insufficient balance during transaction."); }

                        const newBalance = currentBalance - amount;
                        
                        // Deduct balance
                        transaction.update(userDocRef(userState.userId), { 
                            trxBalance: newBalance.toFixed(4) 
                        });
                        balanceDeducted = true;
                        
                        // Add withdrawal request (This will automatically update the Admin Panel)
                        transaction.set(requestsCollection.doc(), {
                            userId: String(userState.userId),
                            userName: userState.name,
                            userUsername: userState.username,
                            amount: amount.toFixed(4),
                            address: accountNumber,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    // 2. Send Telegram notification (Outside of transaction - just a notification)
                    const message = `<b>New Withdraw Request!</b>\n-----------------------------------\n<b>User:</b> ${userState.name} (@${userState.username || 'N/A'})\n<b>User ID:</b> <code>${userState.userId}</code>\n-----------------------------------\n<b>Method:</b> Tron (TRX)\n<b>Account:</b> <code>${accountNumber}</code>\n<b>Amount:</b> ${amount.toFixed(4)} TRX\n-----------------------------------\n<b>Date:</b> ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Dhaka' })}`;
                    
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: message, parse_mode: 'HTML'})
                    });
                    
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("Withdrawal request successfully submitted! Admin panelinde otomatik olarak görünecektir.");
                    withdrawForm.reset();

                } catch (error) {
                    console.error("Withdrawal Error:", error);
                    tg.HapticFeedback.notificationOccurred('error');
                    
                    // Transaction failed. If the error was just with Telegram (i.e. balanceDeducted is true, which shouldn't happen with Firestore Transactions, but for safety in case of partial success outside of the transaction scope):
                    if (balanceDeducted && !error.message.includes("Transaction")) {
                        tg.showAlert("Hata: Çekim talebi Firebase'e kaydedildi ancak Admin'e bildirim gönderilemedi. Admin panelinden kontrol edin.");
                    } else {
                        tg.showAlert(error.message || "Çekim talebi başarısız oldu. Lütfen tekrar deneyin.");
                    }

                } finally {
                    withdrawSubmitBtn.classList.remove('loading');
                    withdrawSubmitBtn.disabled = false;
                    updateUI();
                }
            };
            
            const copyReferralLink = () => {
                const shareText = `💰 **Crypto Earning Made Easy!** Get **$0.30 to $3 daily** in TRX instantly. Start stacking Tron Coin today! Join the Faucet with my referral code for extra rewards: (${userState.userId})\n\nhttps://t.me/${BOT_USERNAME}`;
                
                if (tg.shareText) {
                    tg.shareText(shareText);
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("Share message copied to clipboard!");
                    });
                }
            };

            // ADMIN PANEL FUNCTIONS (Firestore Listeners)
            let unsubscribeRequests = null;
            let unsubscribeUsers = null;
            
            const loadAdminStats = () => {
                // 1. Total User Count (Real-time listener on users collection size)
                if (unsubscribeUsers) unsubscribeUsers(); // Clear previous listener
                unsubscribeUsers = db.collection('users').onSnapshot(snapshot => {
                    totalUsersCountElem.textContent = snapshot.size.toString().padStart(2, '0');
                }, error => {
                    console.error("User Count Error:", error);
                    totalUsersCountElem.textContent = "Error";
                });
                
                // 2. Display Withdrawal Requests (Real-time listener)
                if (unsubscribeRequests) unsubscribeRequests(); // Clear previous listener

                unsubscribeRequests = requestsCollection
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                    
                    let requestsHTML = '';
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (requests.length === 0) {
                        requestsHTML = '<tr><td colspan="4" style="text-align: center; color: var(--subtle-text-light);">No pending requests.</td></tr>';
                    } else {
                        requests.forEach((req, index) => {
                            requestsHTML += `
                                <tr>
                                    <td>#${requests.length - index}</td>
                                    <td>${req.userName || 'Unknown'} <br> <code>${req.userId}</code></td>
                                    <td>${req.amount} TRX</td>
                                    <td><code>${req.address ? req.address.substring(0, 15) + '...' : 'N/A'}</code></td>
                                </tr>
                            `;
                        });
                    }
                    
                    withdrawalRequestsTable.innerHTML = requestsHTML;
                }, error => {
                    console.error("Requests Listener Error:", error);
                    withdrawalRequestsTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--primary-color-light);">Hata: Talepler yüklenemedi.</td></tr>';
                });
            };

            // Admin: Clear all requests (Mark as DONE)
            const handleClearRequests = async () => {
                if (String(userState.userId) !== ADMIN_CHAT_ID) return;
                
                tg.showConfirm("Tüm bekleyen çekim taleplerini TEMİZLEMEK istediğinizden emin misiniz? (Bu işlem geri alınamaz)", async (isConfirmed) => {
                    if (isConfirmed) {
                        try {
                            const snapshot = await requestsCollection.get();
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => {
                                // Delete the document to clear the panel
                                batch.delete(doc.ref);
                            });
                            await batch.commit();

                            tg.HapticFeedback.notificationOccurred('success');
                            tg.showAlert("All pending requests cleared successfully.");

                        } catch (error) {
                            console.error("Error clearing requests:", error);
                            tg.showAlert("Hata: Talepler temizlenirken bir sorun oluştu.");
                        }
                    }
                });
            };

            const setupNavigation = () => {
                const navButtons = document.querySelectorAll('.nav-btn');
                const pages = document.querySelectorAll('.page');
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const pageId = button.dataset.page;
                        pages.forEach(page => page.classList.remove('active'));
                        document.getElementById(pageId).classList.add('active');
                        navButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');

                        // Clean up listener when leaving admin page
                        if (pageId !== 'admin-page' && String(userState.userId) === ADMIN_CHAT_ID) {
                            if (unsubscribeRequests) unsubscribeRequests();
                            if (unsubscribeUsers) unsubscribeUsers();
                            unsubscribeRequests = null;
                            unsubscribeUsers = null;
                        } else if (pageId === 'admin-page' && String(userState.userId) === ADMIN_CHAT_ID) {
                            loadAdminStats(); // Start listener
                        }
                    });
                });
            };

            initApp();
        });
    </script>
</body>
</html>
