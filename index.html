<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TronAdsFaucet</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        /* Google Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');

        /* CSS Variables for Theming */
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color-light: #fefefe; /* Near White */
            --secondary-bg-light: #ffffff;
            --text-color-light: #2c2c2e;
            --subtle-text-light: #8e8e93;
            --primary-color-light: #dc3545; /* Red */
            --primary-color-hover: #c82333; /* Darker Red */
            --border-color-light: #e0e0e0;
            
            /* Theme Styles - Telegram Mini App uses light/dark scheme */
            --primary-color: var(--primary-color-light);
            --secondary-bg: var(--secondary-bg-light);
            --text-color: var(--text-color-light);
            --subtle-text: var(--subtle-text-light);
            --border-color: var(--border-color-light);
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--bg-color-light); 
            color: var(--text-color-light); 
        }

        /* Theme Styles for Telegram App */
        body.light-theme { 
            --primary-color: var(--primary-color-light);
            --secondary-bg: var(--secondary-bg-light);
            --text-color: var(--text-color-light);
            --subtle-text: var(--subtle-text-light);
            --border-color: var(--border-color-light);
        }
        
        /* Telegram Mini App Dark Theme Compatibility */
        @media (prefers-color-scheme: dark) {
            body:not(.light-theme) { /* If no explicit theme is set, use dark */
                background-color: #121212;
                color: #f0f0f0;
                --primary-color: #ff4d4d;
                --secondary-bg: #1e1e1e;
                --text-color: #f0f0f0;
                --subtle-text: #8e8e93;
                --border-color: #38383a;
            }
        }

        #app { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        /* Profile Header */
        .profile-header { 
            padding: 20px 15px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            background-color: var(--secondary-bg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--border-color);
        }
        .profile-info { display: flex; align-items: center; gap: 15px; }
        #user-photo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); }
        .user-details h1 { font-size: 1.1rem; font-weight: 800; }
        .verified-icon { font-size: 0.9rem; margin-left: 5px; color: var(--primary-color); }
        .user-details p { font-size: 0.9rem; font-weight: 600; color: var(--subtle-text); }
        .user-details p span { font-size: 1.1rem; font-weight: 900; color: var(--primary-color); margin-left: 5px; }

        /* Main Content & Pages */
        main { padding: 15px; }
        .page { display: none; }
        .page.active { display: block; animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.6rem; font-weight: 800; margin-bottom: 20px; border-left: 4px solid var(--primary-color); padding-left: 10px; }

        /* Stats & Action Card */
        .card { 
            background-color: var(--secondary-bg); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
            margin-bottom: 25px;
        }
        .stat-item { 
            padding: 15px; 
            border-radius: 12px; 
            text-align: center; 
            background-color: var(--bg-color-light); 
            border: 1px solid var(--border-color);
        }
        .stat-item h3 { font-size: 0.85rem; margin-bottom: 5px; color: var(--subtle-text); font-weight: 600; }
        .stat-item p { font-size: 1.4rem; font-weight: 900; color: var(--primary-color); }
        
        /* Action Button */
        .action-btn { 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1rem; 
            font-weight: 800; 
            color: #fff; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            background-color: var(--primary-color);
            transition: background-color 0.2s, transform 0.1s; 
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        .action-btn:hover:not(:disabled) { background-color: var(--primary-color-hover); }
        .action-btn:active:not(:disabled) { transform: translateY(1px); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .action-btn i { margin-right: 10px; }

        /* Referral Section */
        .referral-section h3 { font-size: 1.2rem; text-align: center; font-weight: 800; margin-bottom: 10px; }
        #referral-link { 
            width: 100%; 
            padding: 12px; 
            text-align: center; 
            border: 1px dashed var(--primary-color); 
            border-radius: 8px; 
            margin: 15px 0; 
            font-size: 0.9rem; 
            background-color: var(--bg-color-light); 
            color: var(--text-color);
        }
        #copy-ref-link-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 700; background-color: var(--primary-color); transition: background-color 0.2s; }

        /* Form Styles */
        #withdraw-form .form-group { margin-bottom: 20px; }
        #withdraw-form label { display: block; margin-bottom: 8px; font-weight: 700; }
        #withdraw-form input, #withdraw-form select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            font-family: var(--font-family); 
            font-size: 1rem; 
            border: 1px solid var(--border-color); 
            background-color: var(--bg-color-light); 
            color: var(--text-color); 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15); 
        }

        /* Bottom Navigation */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            max-width: 500px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid var(--border-color); 
            background-color: var(--secondary-bg);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            z-index: 1000; 
        }
        .nav-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 5px 10px; 
            font-family: var(--font-family); 
            font-size: 0.75rem; 
            transition: color 0.2s; 
            flex-grow: 1; 
            color: var(--subtle-text);
            font-weight: 700;
        }
        .nav-btn i { font-size: 1.6rem; margin-bottom: 3px; }
        .nav-btn.active { color: var(--primary-color); }

        /* Admin Button */
        #admin-btn {
            position: absolute;
            top: 25px;
            right: 15px;
            background: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
            display: none; /* Initial hide, will show if user is admin */
        }
        #admin-btn:hover { opacity: 0.9; }

    </style>
</head>
<body>

    <div id="app">
        <header class="profile-header">
            <div class="profile-info">
                <img id="user-photo" src="https://i.imgur.com/placeholder.png" alt="User Photo">
                <div class="user-details">
                    <h1 id="user-name">Loading... <i class="fas fa-bolt verified-icon"></i></h1>
                    <p>Balance: <span id="user-points">0.0000</span> TRX</p>
                </div>
            </div>
            <button id="admin-btn" style="display: none;">Admin Panel</button>
        </header>

        <main id="main-content">
            <div id="home-page" class="page active">
                <h2>TronAds Faucet</h2>
                
                <div class="card">
                    <h3>Current Stats</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <h3>TRX Price</h3>
                            <p>$<span id="trx-price-usd">0.00</span></p>
                        </div>
                        <div class="stat-item">
                            <h3>Daily Ads</h3>
                            <p><span id="daily-ads-watched">0</span> / 25</p>
                        </div>
                        <div class="stat-item">
                            <h3>Ad Reward</h3>
                            <p><span id="ad-reward-trx">0.0000</span> TRX</p>
                        </div>
                    </div>
                    
                    <button id="watch-ad-btn" class="action-btn">
                        <i class="fas fa-video"></i> Watch Ad & Earn
                    </button>
                </div>

                <div class="referral-section card">
                    <h3>Refer & Earn More!</h3>
                    <p style="color: var(--subtle-text); font-size: 0.9rem;">Share your link and get a bonus for every referral.</p>
                    <input type="text" id="referral-link" readonly>
                    <button id="copy-ref-link-btn" class="action-btn" style="background-color: #5cb85c; margin-top: 10px;">
                        <i class="fas fa-link"></i> Copy Referral Link
                    </button>
                    <div class="stat-item" style="margin-top: 15px; border: none; background: none;">
                        <h3>Total Referrals</h3>
                        <p id="referral-count">0</p>
                    </div>
                </div>

            </div>
            
            <div id="withdraw-page" class="page">
                <h2>Withdraw TRX</h2>
                <p style="color: var(--subtle-text); margin-bottom: 20px;">Minimum <span style="font-weight: 700; color: var(--primary-color);">0.10 TRX</span> required to withdraw.</p>
                <form id="withdraw-form" class="card">
                    <div class="form-group">
                        <label for="withdraw-method">Method:</label>
                        <select id="withdraw-method" disabled required>
                            <option value="Tron (TRX)">Tron (TRX)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="account-number">Tron Wallet Address:</label>
                        <input type="text" id="account-number" placeholder="Enter your TRX Wallet Address (T...)" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">TRX to Withdraw:</label>
                        <input type="number" id="amount" placeholder="e.g., 0.15" required step="0.0001">
                    </div>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn">
                        <i class="fas fa-hand-holding-usd"></i> Submit Withdrawal
                    </button>
                </form>
            </div>
            
            <div id="admin-page" class="page">
                <h2>Admin Panel</h2>
                <div class="card">
                    <h3>Withdrawal Requests</h3>
                    <p style="color: var(--subtle-text);">Fetching live withdrawal requests from Firebase...</p>
                    <ul id="withdrawal-list" style="list-style: none; padding: 0; margin-top: 15px;">
                        </ul>
                </div>
            </div>

        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
            <button class="nav-btn" data-page="home-page" onclick="document.getElementById('home-page').scrollIntoView({ behavior: 'smooth' });"><i class="fas fa-users"></i><span>Referral</span></button>
        </nav>
    </div>

    <script src="https://adexora.com/cdn/ads.js?id=494"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCGGHZROaP3RkFs-a293uTFaWn521y3BeM",
            authDomain: "tronadsfaucet.firebaseapp.com",
            databaseURL: "https://tronadsfaucet-default-rtdb.firebaseio.com",
            projectId: "tronadsfaucet",
            storageBucket: "tronadsfaucet.firebasestorage.app",
            messagingSenderId: "26180984735",
            appId: "1:26180984735:web:e498a635c4f61bd0a167aa",
            measurementId: "G-WG3ETVHC78"
        };
        const firebaseApp = firebase.initializeApp(firebaseConfig);
        const database = firebaseApp.database();
        
        // --- Configuration ---
        const BOT_USERNAME = "TronAdsFaucetBot"; 
        const ADMIN_ID = "7904032877";
        const DAILY_AD_LIMIT = 25;
        const EARNING_PER_AD_USD = 0.001; // $0.001 per ad
        const MIN_WITHDRAW_TRX = 0.10;
        const COINGECKO_API_URL = 'https://api.coingecko.com/api/v3/simple/price?ids=tron&vs_currencies=usd';
        
        // Bu değer, API çağrısı başarısız olursa veya ilk yükleme sırasında kullanılır.
        let CURRENT_TRX_PRICE_USD = 0.08; 
        
        // --- DOM Elements ---
        const userPhotoElem = document.getElementById('user-photo');
        const userNameElem = document.getElementById('user-name');
        const userPointsElem = document.getElementById('user-points');
        const dailyAdsWatchedElem = document.getElementById('daily-ads-watched');
        const referralCountElem = document.getElementById('referral-count');
        const watchAdBtn = document.getElementById('watch-ad-btn');
        const withdrawForm = document.getElementById('withdraw-form');
        const withdrawSubmitBtn = document.getElementById('withdraw-submit-btn');
        const referralLinkElem = document.getElementById('referral-link');
        const copyRefLinkBtn = document.getElementById('copy-ref-link-btn');
        const adminBtn = document.getElementById('admin-btn');
        const trxPriceUSDElem = document.getElementById('trx-price-usd');
        const adRewardTRXElem = document.getElementById('ad-reward-trx');
        
        // --- State Management ---
        let userState = {
            pointsTRX: 0,
            dailyAdWatchCount: 0,
            lastAdWatchDate: null,
            referrals: 0,
            userId: null,
            uniqueRefCode: null, 
            isNewUser: true
        };

        const calculateTrxReward = () => {
             // Kazanç USD / TRX Fiyatı USD = TRX
            return EARNING_PER_AD_USD / CURRENT_TRX_PRICE_USD;
        };
        
        // --- Fiyat Çekme Fonksiyonu ---
        const fetchTrxPrice = async () => {
            try {
                const response = await fetch(COINGECKO_API_URL);
                const data = await response.json();
                
                if (data.tron && data.tron.usd) {
                    CURRENT_TRX_PRICE_USD = data.tron.usd;
                } else {
                    console.warn("CoinGecko API'den beklenen TRX fiyat verisi alınamadı. Varsayılan değer kullanılıyor.");
                }
            } catch (error) {
                console.error("CoinGecko fiyat çekme hatası:", error);
            }
        };

        const generateUniqueCode = (id) => {
            return btoa(String(id)).substring(0, 8).toUpperCase().replace(/=/g, '');
        };
        
        const saveStateToFirebase = () => {
            if(userState.userId) {
                const userRef = database.ref(`users/${userState.userId}`);
                userRef.set({
                    pointsTRX: parseFloat(userState.pointsTRX.toFixed(4)), 
                    dailyAdWatchCount: userState.dailyAdWatchCount,
                    lastAdWatchDate: userState.lastAdWatchDate,
                    referrals: userState.referrals,
                    uniqueRefCode: userState.uniqueRefCode,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                });
            }
        };

        const loadStateFromFirebase = (userId) => {
            return new Promise((resolve, reject) => {
                const userRef = database.ref(`users/${userId}`);
                userRef.once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        userState.pointsTRX = data.pointsTRX || 0;
                        userState.dailyAdWatchCount = data.dailyAdWatchCount || 0;
                        userState.lastAdWatchDate = data.lastAdWatchDate || null;
                        userState.referrals = data.referrals || 0;
                        userState.uniqueRefCode = data.uniqueRefCode || generateUniqueCode(userId);
                        userState.isNewUser = false;
                    } else {
                        // Yeni kullanıcı başlatma
                        userState.uniqueRefCode = generateUniqueCode(userId);
                        userState.isNewUser = true;
                        
                        // Referans kontrolü (start parametresi)
                        const startParam = new URLSearchParams(window.Telegram.WebApp.initData).get('start');
                        if (startParam && startParam.startsWith('ref_')) {
                            const referrerCode = startParam.replace('ref_', '');
                            checkAndProcessReferral(referrerCode, userId);
                        }
                    }
                    resolve();
                }, (error) => {
                    console.error("Firebase yükleme hatası:", error);
                    reject(error);
                });
            });
        };
        
        const checkAndProcessReferral = (referrerCode, newUserId) => {
            database.ref('users').orderByChild('uniqueRefCode').equalTo(referrerCode).once('value', (snapshot) => {
                const users = snapshot.val();
                if (users) {
                    const referrerId = Object.keys(users)[0];
                    if (referrerId !== String(newUserId)) {
                        const referrerData = users[referrerId];
                        const newReferrals = (referrerData.referrals || 0) + 1;
                        // Referansçının sayısını güncelle
                        database.ref(`users/${referrerId}/referrals`).set(newReferrals);
                    }
                }
            });
        };

        // --- Core Functions ---
        const initApp = async () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            // Tema rengini Telegram'dan al
            document.body.className = `${tg.colorScheme}-theme`;

            const user = tg.initDataUnsafe.user;
            if (!user || !user.id) {
                tg.showAlert("Kullanıcı doğrulanamadı. Lütfen uygulamayı Telegram üzerinden açın.", () => tg.close());
                return;
            }
            
            userState.userId = String(user.id);
            
            // 1. Fiyatı CoinGecko'dan çek
            await fetchTrxPrice();
            
            // 2. Firebase durumunu yükle
            try {
                await loadStateFromFirebase(userState.userId);
            } catch (e) {
                tg.showAlert("Kullanıcı verisi yüklenirken hata oluştu. Lütfen tekrar deneyin.");
                console.error(e);
                return;
            }
            
            // 3. Günlük Sıfırlama Kontrolü
            const today = new Date().toISOString().slice(0, 10);
            if (userState.lastAdWatchDate !== today) {
                userState.dailyAdWatchCount = 0;
                userState.lastAdWatchDate = today;
            }
            
            // 4. UI'ı Kur
            updateUI();
            setupNavigation();
            setupEventListeners();
            
            // 5. İlk durumu kaydet (Yeni kullanıcılar veya günlük sıfırlama için)
            saveStateToFirebase();

            // 6. Admin kontrolü
            if (userState.userId === ADMIN_ID) {
                adminBtn.style.display = 'block';
            }
        };
        
        const updateUI = () => {
            const tg = window.Telegram.WebApp;
            const user = tg.initDataUnsafe.user;
            
            // Header
            if (user) {
                // Not: Telegram'ın bot api'si üzerinden fotoğraf çekilmesi daha güvenli ve doğru olabilir.
                // Mini App'te sadece düşük çözünürlüklü bir fotoğraf URL'si döner.
                userPhotoElem.src = user.photo_url || 'https://i.imgur.com/placeholder.png';
                userNameElem.innerHTML = `${user.first_name || 'User'} <i class="fas fa-bolt verified-icon"></i>`;
            }
            
            const rewardTRX = calculateTrxReward();
            
            userPointsElem.textContent = parseFloat(userState.pointsTRX).toFixed(4);
            dailyAdsWatchedElem.textContent = userState.dailyAdWatchCount;
            referralCountElem.textContent = userState.referrals;
            trxPriceUSDElem.textContent = CURRENT_TRX_PRICE_USD.toFixed(4); // Fiyatı 4 ondalık basamakla göster
            adRewardTRXElem.textContent = parseFloat(rewardTRX).toFixed(4);

            // Referans Linki güncelleme
            referralLinkElem.value = `https://t.me/${BOT_USERNAME}?start=ref_${userState.uniqueRefCode}`;

            // Buton durumu
            if (userState.dailyAdWatchCount >= DAILY_AD_LIMIT) {
                watchAdBtn.textContent = 'Daily Limit Reached';
                watchAdBtn.disabled = true;
            } else {
                watchAdBtn.textContent = `Watch Ad & Earn`;
                watchAdBtn.disabled = false;
            }
        };
        
        const setupEventListeners = () => {
            watchAdBtn.addEventListener('click', handleWatchAd);
            withdrawForm.addEventListener('submit', handleWithdraw);
            copyRefLinkBtn.addEventListener('click', copyReferralLink);
            adminBtn.addEventListener('click', () => {
                // Admin sayfasına geçiş
                document.querySelector('.page.active').classList.remove('active');
                document.getElementById('admin-page').classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                adminBtn.classList.add('active'); // Admin butonu aktif hale getirildi
                loadWithdrawalRequests();
            });
        };

        const handleWatchAd = () => {
            if (userState.dailyAdWatchCount >= DAILY_AD_LIMIT) {
                tg.showAlert("Günlük reklam izleme limitine ulaştınız."); return;
            }
            
            watchAdBtn.disabled = true;
            watchAdBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Ad...';

            window.showAdexora()
                .then(async () => {
                    // Adexora reklam kodu burası (Reward Logic Here)
                    
                    // Önce güncel TRX fiyatını tekrar kontrol et (opsiyonel ama güvenli)
                    await fetchTrxPrice();
                    const rewardTRX = calculateTrxReward();
                    
                    userState.pointsTRX += rewardTRX;
                    userState.dailyAdWatchCount++;
                    
                    saveStateToFirebase();
                    updateUI();
                    
                    const tg = window.Telegram.WebApp;
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert(`Tebrikler! ${parseFloat(rewardTRX).toFixed(4)} TRX kazandınız.`);

                })
                .catch(e => {
                    // Reklam engellendi veya yüklenemedi (Handle errors here)
                    const tg = window.Telegram.WebApp;
                    tg.showAlert("Reklam yüklenemedi veya engellendi. Lütfen daha sonra tekrar deneyin.");
                    console.error("Adexora Hata:", e);
                })
                .finally(() => {
                    // Butonu eski haline getir
                    watchAdBtn.disabled = false;
                    watchAdBtn.innerHTML = '<i class="fas fa-video"></i> Watch Ad & Earn';
                    updateUI(); 
                });
        };

        const handleWithdraw = async (e) => {
            e.preventDefault();
            const accountNumber = document.getElementById('account-number').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const tg = window.Telegram.WebApp;

            if (isNaN(amount) || amount <= 0) { tg.showAlert("Lütfen geçerli bir miktar girin."); return; }
            if (!accountNumber.startsWith('T') || accountNumber.length < 34) { tg.showAlert("Lütfen geçerli bir Tron Wallet Adresi (T ile başlamalı) girin."); return; }
            if (amount < MIN_WITHDRAW_TRX) { tg.showAlert(`Minimum çekim ${MIN_WITHDRAW_TRX.toFixed(2)} TRX.`); return; }
            if (amount > userState.pointsTRX) { tg.showAlert("Bakiyeniz yeterli değil."); return; }

            withdrawSubmitBtn.disabled = true;
            withdrawSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            // Bakiyeden düşülür
            userState.pointsTRX -= amount;
            
            const withdrawRef = database.ref('withdrawals').push();
            const user = tg.initDataUnsafe.user;
            
            const requestData = {
                userId: userState.userId,
                username: user.username || 'N/A',
                firstName: user.first_name || '',
                amountTRX: parseFloat(amount.toFixed(4)),
                accountNumber: accountNumber,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'Pending'
            };

            try {
                await withdrawRef.set(requestData);
                saveStateToFirebase(); // Yeni bakiyeyi kaydet
                updateUI();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Çekim talebiniz başarıyla gönderildi!");
                withdrawForm.reset();
                
            } catch (error) {
                // Hata olursa, puanları iade et
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert("Talep gönderilemedi. Bakiyeniz iade edildi.");
                userState.pointsTRX += amount;
                saveStateToFirebase();
                updateUI();
            } finally {
                withdrawSubmitBtn.disabled = false;
                withdrawSubmitBtn.innerHTML = '<i class="fas fa-hand-holding-usd"></i> Submit Withdrawal';
            }
        };
        
        const copyReferralLink = () => {
            const tg = window.Telegram.WebApp;
            navigator.clipboard.writeText(referralLinkElem.value).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Referans linki kopyalandı!");
            });
        };

        const setupNavigation = () => {
            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Referral butonu (sonuncu) tıklandığında sadece home sayfasına kaydırma yap.
                    if (button.textContent.trim() === 'Referral') {
                        document.getElementById('home-page').scrollIntoView({ behavior: 'smooth' });
                        return; 
                    }

                    const pageId = button.dataset.page;
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                });
            });
        };

        // Admin Panel Fonksiyonları
        const loadWithdrawalRequests = () => {
            const list = document.getElementById('withdrawal-list');
            list.innerHTML = '<p style="text-align: center;">Talepler yükleniyor...</p>';

            database.ref('withdrawals').orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
                const requests = snapshot.val();
                list.innerHTML = '';
                let requestCount = 0;

                if (requests) {
                    const requestArray = Object.entries(requests).map(([key, value]) => ({ id: key, ...value })).reverse();
                    
                    requestArray.forEach(req => {
                        const date = new Date(req.timestamp).toLocaleString();
                        const statusColor = req.status === 'Pending' ? 'orange' : (req.status === 'Completed' ? 'green' : 'red');
                        requestCount++;
                        
                        const listItem = document.createElement('li');
                        listItem.style.cssText = `border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 10px;`;
                        listItem.innerHTML = `
                            <strong>ID:</strong> ${req.userId} | <strong>User:</strong> @${req.username}<br>
                            <strong>Amount:</strong> <span style="color: var(--primary-color); font-weight: 700;">${req.amountTRX} TRX</span><br>
                            <strong>Wallet:</strong> <code>${req.accountNumber}</code><br>
                            <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: 700;">${req.status}</span><br>
                            <small>Time: ${date}</small>
                            <div style="margin-top: 10px;">
                                <button data-id="${req.id}" data-status="Completed" style="background-color: green; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px;">Complete</button>
                                <button data-id="${req.id}" data-status="Rejected" style="background-color: red; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Reject</button>
                            </div>
                        `;
                        list.appendChild(listItem);
                    });
                }

                if (requestCount === 0) {
                     list.innerHTML = '<p style="text-align: center; color: var(--subtle-text);">Bekleyen talep bulunmamaktadır.</p>';
                }

                list.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const status = e.target.dataset.status;
                        updateWithdrawalStatus(id, status);
                    });
                });

            }, (error) => {
                list.innerHTML = `<p style="text-align: center; color: red;">Talepler yüklenirken hata: ${error.message}</p>`;
                console.error(error);
            });
        };

        const updateWithdrawalStatus = (requestId, newStatus) => {
            // Not: Bu işlem normalde sunucu tarafında yapılmalıdır.
            database.ref(`withdrawals/${requestId}/status`).set(newStatus)
                .then(() => {
                    window.Telegram.WebApp.showAlert(`Talep ${requestId} durumu ${newStatus} olarak ayarlandı.`);
                })
                .catch(error => {
                    window.Telegram.WebApp.showAlert(`Durum güncellenemedi: ${error.message}`);
                });
        };

        initApp();
    </script>
</body>
</html>
