<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tron Ads Faucet</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <script src="https://adexora.com/cdn/ads.js?id=494"></script>

    <style>
        /* CSS Variables for Theming - RED & WHITE */
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color: #f0f2f5; /* Light background for body */
            --card-bg: #ffffff;
            --text-color: #1c1c1e;
            --subtle-text: #888;
            --primary-color: #D32F2F; /* Deep Red */
            --primary-color-hover: #B71C1C;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        /* Header */
        .header { padding: 20px; display: flex; align-items: center; justify-content: space-between; background-color: var(--primary-color); color: white; border-radius: 0 0 var(--radius) var(--radius); box-shadow: var(--shadow); }
        .header h1 { font-size: 1.4rem; font-weight: 800; }
        .header-stats { text-align: right; font-size: 0.9rem; }
        .header-stats p strong { display: block; font-size: 1.1rem; }

        /* Main Content & Pages */
        main { padding: 15px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.6rem; margin-bottom: 20px; color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 10px; }
        
        /* Card Styles */
        .card { padding: 20px; border-radius: var(--radius); background-color: var(--card-bg); box-shadow: var(--shadow); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        /* Action Button (Primary Red) */
        .action-btn { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 700; color: #fff; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; display: flex; justify-content: center; align-items: center; background-color: var(--primary-color); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:hover { background-color: var(--primary-color-hover); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        /* Loading/Processing State */
        .action-btn.loading { background-color: #FF5722; cursor: wait; pointer-events: none; }


        /* Menu Page - Balance */
        .balance-card { text-align: center; border: 2px solid var(--primary-color); background-color: #FFF3F3; }
        .balance-card .usd-value { font-size: 2.5rem; font-weight: 800; color: var(--primary-color); line-height: 1.2; }
        .balance-card .trx-value { font-size: 1.2rem; color: var(--subtle-text); margin-top: 5px; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .menu-tile { padding: 15px; border-radius: var(--radius); text-align: center; background-color: var(--card-bg); box-shadow: var(--shadow); cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .menu-tile i { font-size: 2rem; color: var(--primary-color); margin-bottom: 10px; }
        .menu-tile span { font-size: 1rem; font-weight: 600; display: block; }
        .menu-tile:hover { background-color: #FFFAFA; }

        /* Form Elements (Shared) */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 700; font-size: 0.95rem; color: var(--text-color); }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border-radius: 8px; font-family: inherit; font-size: 1rem; border: 1px solid var(--border-color); transition: border-color 0.2s; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: var(--primary-color); outline: none; }
        
        /* Referral & Copy */
        .input-group { display: flex; margin-bottom: 15px; }
        .input-group input { flex-grow: 1; border-radius: 8px 0 0 8px; border-right: none; background-color: var(--bg-color); }
        .input-group button { padding: 10px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 0 8px 8px 0; cursor: pointer; transition: background-color 0.2s; }
        .input-group button:hover { background-color: var(--primary-color-hover); }

        /* Withdrawal Details */
        .withdraw-note { font-size: 0.9rem; color: var(--subtle-text); margin-top: 10px; }
        
        /* Admin Panel */
        #admin-panel .stat-display { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--border-color); font-weight: 600; }
        #admin-panel h3 { margin-top: 20px; color: var(--primary-color); }
        #admin-panel ul { list-style: none; padding: 0; }
        #admin-panel li { border: 1px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; background-color: #FFEEEE; }
        #admin-panel li strong { color: var(--primary-color); }
        #admin-panel li button { margin-top: 10px; margin-right: 5px; padding: 8px 12px; border-radius: 5px; font-weight: 700; cursor: pointer; }
        #admin-panel .approve-btn { background-color: #4CAF50; color: white; border: none; }
        #admin-panel .reject-btn { background-color: #f44336; color: white; border: none; }


        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; display: flex; justify-content: space-around; padding: 5px 0; background-color: var(--card-bg); border-top: 1px solid var(--border-color); box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); z-index: 1000; }
        .nav-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; padding: 5px 10px; font-family: var(--font-family); font-size: 0.75rem; transition: color 0.2s; flex-grow: 1; color: var(--subtle-text); }
        .nav-btn i { font-size: 1.6rem; margin-bottom: 3px; }
        .nav-btn.active { font-weight: 700; color: var(--primary-color); }
    </style>
</head>
<body>

    <div id="app">
        <header class="header">
            <div>
                <h1>TRON Ads Faucet</h1>
                <p style="font-size:0.9rem;">The simplest way to earn TRX.</p>
            </div>
            <div class="header-stats">
                <p>Current Price (TRX)</p>
                <p><strong>$<span id="current-trx-price">0.0000</span></strong></p>
                <div id="admin-indicator" style="display:none; font-weight:bold; color:#FFD700; margin-top:5px;">ADMIN MODE</div>
            </div>
        </header>

        <main id="main-content">
            
            <div id="admin-panel" class="page">
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                <div class="card">
                    <h3>System Stats (RTDB)</h3>
                    <div class="stat-display"><span>Total Users:</span> <strong id="admin-user-count">0</strong></div>
                    <div class="stat-display"><span>Total User Balance (USD):</span> <strong id="admin-total-balance">$0.00</strong></div>
                    <div class="stat-display"><span>Total Ads Watched (Lifetime):</span> <strong id="admin-total-ads">0</strong></div>
                    <div class="stat-display"><span>Total Approved Payments (USD):</span> <strong id="admin-approved-payments">$0.00</strong></div>
                </div>
                
                <h3 style="margin-top:25px;">Pending Withdrawal Requests (Firestore)</h3>
                <ul id="withdrawal-list">
                    <p style="color:var(--subtle-text);">Loading requests...</p>
                </ul>
            </div>

            <div id="menu-page" class="page active">
                <h2><i class="fas fa-home"></i> Home & Earning</h2>
                <div class="card balance-card">
                    <p style="font-size:1.1rem; color:var(--subtle-text);">Your Current Balance (TRX)</p>
                    <div class="usd-value"><span id="menu-balance-trx">0.0000</span> TRX</div>
                    <div class="trx-value">â‰ˆ $<span id="menu-balance-usd">0.00</span></div>
                </div>
                
                <div class="card" style="text-align: center; border-left: 5px solid var(--primary-color);">
                    <i class="fas fa-video" style="font-size:3rem; color: var(--primary-color);"></i>
                    <h3>Watch & Earn</h3>
                    <p style="margin-bottom:15px;">You earn **$0.001** worth of TRX per rewarded ad.</p>
                    <button id="watch-ad-btn" class="action-btn">
                        <i class="fas fa-play-circle" style="margin-right:10px;"></i> Watch Ad
                    </button>
                    <p class="withdraw-note" style="margin-top:10px;">Ads Watched Today: <strong id="daily-ads-watched">0</strong> / 100</p>
                </div>

                <div class="menu-grid" style="margin-top: 15px;">
                    <div onclick="showSection('friends-page')" class="menu-tile">
                        <i class="fas fa-users"></i>
                        <span>Friends & Referrals</span>
                    </div>
                    <div onclick="showSection('withdraw-page')" class="menu-tile">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw TRX</span>
                    </div>
                </div>
            </div>

            <div id="friends-page" class="page">
                <h2><i class="fas fa-user-friends"></i> Referral System</h2>
                <div class="card">
                    <p style="font-weight:700; color:var(--primary-color);">Referral Bonus: Get **$0.02** worth of TRX for every successful friend!</p>
                    
                    <h3 style="font-size:1.2rem; margin-top:15px; margin-bottom:5px;">Your Referral Link (Share this!)</h3>
                    <div class="input-group">
                        <input type="text" id="referral-code-input" value="" placeholder="Loading..." readonly>
                        <button onclick="copyToClipboard('referral-code-input')"><i class="fas fa-copy"></i> Copy Link</button>
                    </div>
                    
                    <button id="share-ref-btn" class="action-btn" style="margin-top:0;"><i class="fas fa-share-alt" style="margin-right:10px;"></i> Share Promotional Text</button>

                    <h3 style="font-size:1.2rem; margin-top:25px; margin-bottom:5px;">Enter Friend's Code</h3>
                    <p class="withdraw-note">You can only use one code once.</p>
                    <div class="input-group">
                        <input type="text" id="enter-referrer-code" placeholder="Enter friend's Telegram ID">
                        <button onclick="applyReferralCode()"><i class="fas fa-arrow-right"></i> Apply</button>
                    </div>
                </div>
            </div>
            
            <div id="withdraw-page" class="page">
                <h2><i class="fas fa-money-check-alt"></i> Withdraw TRX</h2>
                <div class="card balance-card" style="margin-bottom: 20px;">
                    <p style="font-size:0.9rem; color:var(--subtle-text);">Available TRX:</p>
                    <div class="usd-value" style="font-size:2rem;"><span id="withdraw-balance-trx">0.0000</span> TRX</div>
                </div>
                <p style="font-weight:700;">Minimum withdrawal: **0.01 TRX**.<br>Maximum withdrawal: **10.00 TRX**.</p>
                <form id="withdraw-form" style="margin-top:15px;">
                    <div class="form-group">
                        <label for="tron-address"><i class="fas fa-truck-moving"></i> TRON Wallet Address:</label>
                        <input type="text" id="tron-address" placeholder="Txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    </div>
                    <div class="form-group">
                        <label for="amount-trx"><i class="fas fa-coins"></i> Amount (TRX):</label>
                        <input type="number" id="amount-trx" step="0.001" placeholder="e.g., 0.019" required>
                    </div>
                    <p class="withdraw-note">This equals: <strong id="withdraw-usd-amount">$0.00</strong> USD</p>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn" style="margin-top:15px;">
                        <i class="fas fa-paper-plane" style="margin-right:10px;"></i> Submit Withdrawal Request
                    </button>
                </form>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="menu-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="friends-page"><i class="fas fa-users"></i><span>Friends</span></button>
            <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
            </nav>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        
        // --- REALTIME DATABASE IMPORTS (KullanÄ±cÄ± Verileri) ---
        import { getDatabase, ref as rtdbRef, get as rtdbGet, set as rtdbSet, update as rtdbUpdate, onValue as rtdbOnValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        
        // --- FIRESTORE IMPORTS (Ã‡ekim Talepleri) ---
        import { getFirestore, collection, addDoc, doc, updateDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";


        // --- CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAYJqf6Y090mN4fjQAR9m7hNil7hjn0HMg",
            authDomain: "tronadsfaucet-fd451.firebaseapp.com",
            databaseURL: "https://tronadsfaucet-fd451-default-rtdb.firebaseio.com",
            projectId: "tronadsfaucet-fd451",
            storageBucket: "tronadsfaucet-fd451.firebasestorage.app",
            messagingSenderId: "110511122993",
            appId: "1:110511122993:web:99099461844e1fbbe10310",
            measurementId: "G-VZ3Z6SFMXZ"
        };
        const ADMIN_TELEGRAM_IDS = ["7904032877", "8392479231"]; 
        const AD_LIMIT = 100;
        const EARNINGS_PER_AD_USD = 0.001;
        const REFERRAL_BONUS_USD = 0.02;
        const MIN_WITHDRAW_TRX = 0.01; 
        const MAX_WITHDRAW_TRX = 10.00; 
        const BOT_USERNAME = "TronAdsFaucetBot"; 
        
        // --- GLOBAL STATE ---
        let currentTronPriceUsd = 0.0; 
        let userUid = null;
        let telegramId = null;

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(FIREBASE_CONFIG);
        const rtdb = getDatabase(app); // Realtime Database
        const firestore = getFirestore(app); // Cloud Firestore

        // --- UTILITY FUNCTIONS ---
        const getUidFromTelegramId = (id) => `tg_user_${id}`;
        
        // Navigation Handler
        window.showSection = (sectionId) => {
            document.querySelectorAll('.page').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-page="${sectionId}"]`)?.classList.add('active');

            if (sectionId === 'admin-panel') loadAdminPanel();
        }

        // Copy to Clipboard
        window.copyToClipboard = (elementId) => {
            const copyText = document.getElementById(elementId);
            const code = copyText.value;
            const fullLink = `https://t.me/${BOT_USERNAME}?start=${code}`;

            navigator.clipboard.writeText(fullLink).then(() => {
                window.Telegram.WebApp.showAlert("Referral Link copied to clipboard!");
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }).catch(err => {
                 window.Telegram.WebApp.showAlert(`Failed to copy: ${err}`);
            });
        }
        
        // --- DATA FETCHING & UI UPDATES ---
        
        async function fetchTronPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tron&vs_currencies=usd');
                const data = await response.json();
                currentTronPriceUsd = data.tron.usd;
                document.getElementById('current-trx-price').textContent = currentTronPriceUsd.toFixed(4);
            } catch (error) {
                console.error("Error fetching Tron price, using fallback:", error);
                currentTronPriceUsd = 0.03389; // Fallback value
                document.getElementById('current-trx-price').textContent = `F: ${currentTronPriceUsd.toFixed(4)}`;
            }
        }
        
        // Real-time listener for user data (RTDB)
        function setupUserListener() {
            if (!userUid) return;
            // RTDB Ref kullanÄ±ldÄ±
            const userRef = rtdbRef(rtdb, 'users/' + userUid); 
            
            // rtdbOnValue kullanÄ±ldÄ±
            rtdbOnValue(userRef, (snapshot) => {
                let userData = snapshot.val();
                const userTgData = window.Telegram.WebApp.initDataUnsafe.user;
                
                if (!snapshot.exists()) {
                    // Initialize New User (RTDB Set kullanÄ±ldÄ±)
                    const newUser = {
                        telegram_id: telegramId,
                        username: userTgData?.username || `user_${telegramId}`,
                        first_name: userTgData?.first_name || 'User',
                        balance_usd: 0.0, 
                        referred_by: null,
                        daily_ads_watched: 0,
                        lifetime_ads_watched: 0, // Yeni eklenen alan
                        referral_code: telegramId.toString(), 
                        created_at: serverTimestamp()
                    };
                    rtdbSet(userRef, newUser);
                    userData = newUser;
                }

                const balanceUsd = userData.balance_usd || 0.0;
                const balanceTrx = currentTronPriceUsd > 0 ? (balanceUsd / currentTronPriceUsd) : 0; 
                const dailyWatched = userData.daily_ads_watched || 0;

                // Update UI (TRX & USD)
                document.getElementById('menu-balance-trx').textContent = balanceTrx.toFixed(4);
                document.getElementById('menu-balance-usd').textContent = balanceUsd.toFixed(2);
                document.getElementById('withdraw-balance-trx').textContent = balanceTrx.toFixed(4);
                document.getElementById('daily-ads-watched').textContent = dailyWatched;
                
                document.getElementById('referral-code-input').value = userData.referral_code;

                if (userData.referred_by) {
                    document.getElementById('enter-referrer-code').disabled = true;
                    document.getElementById('enter-referrer-code').placeholder = `Already referred by: ${userData.referred_by}`;
                    document.querySelector('#friends-page .input-group button').disabled = true;
                }
            }, (error) => {
                console.error("User Data Listener Error:", error);
            });
        }
        
        // --- AD VIEW LOGIC (RTDB) ---
        
        const handleWatchAd = () => {
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const userRef = rtdbRef(rtdb, 'users/' + userUid); // RTDB Ref
            
            rtdbGet(userRef).then((snapshot) => { // RTDB Get
                const userData = snapshot.val();
                let adsWatched = userData.daily_ads_watched || 0;
                const currentBalance = userData.balance_usd || 0.0;
                const lifetimeAds = userData.lifetime_ads_watched || 0; // Yeni: Lifetime Ad count

                if (adsWatched >= AD_LIMIT) {
                    return window.Telegram.WebApp.showAlert(`You have reached the daily ad viewing limit (${AD_LIMIT}).`);
                }

                watchAdBtn.disabled = true;
                watchAdBtn.classList.add('loading');
                watchAdBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:10px;"></i> Loading Ad...';

                window.showAdexora()
                  .then(() => {
                    adsWatched++;
                    const newBalance = currentBalance + EARNINGS_PER_AD_USD;

                    rtdbUpdate(userRef, { // RTDB Update
                        balance_usd: newBalance,
                        daily_ads_watched: adsWatched,
                        lifetime_ads_watched: lifetimeAds + 1, // Yeni: Lifetime artÄ±rÄ±ldÄ±
                        last_ad_viewed: serverTimestamp()
                    });
                    
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    window.Telegram.WebApp.showAlert(`Success! You earned $${EARNINGS_PER_AD_USD.toFixed(3)} worth of TRX.`);
                  })
                  .catch(e => {
                    window.Telegram.WebApp.showAlert("Ad not shown or skipped. Please try again.");
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                  })
                  .finally(() => {
                    watchAdBtn.disabled = false;
                    watchAdBtn.classList.remove('loading');
                    watchAdBtn.innerHTML = '<i class="fas fa-play-circle" style="margin-right:10px;"></i> Watch Ad';
                  });
            });
        }

        // --- REFERRAL LOGIC (RTDB) ---
        
        const handleShareReferral = () => {
            const userCode = document.getElementById('referral-code-input').value;
            const telegramLink = `https://t.me/${BOT_USERNAME}?start=${userCode}`;

            const shareText = 
`ðŸ’° TRON ADS FAUCET - FREE TRX! ðŸš€

I'm earning free TRX every day just by watching short ads! You can earn up to $0.30 - $3.00 USD daily with minimal effort.

ðŸ”¥ **REFERRAL BONUS:** Join using my link and start earning. When you invite friends, you get a bonus $0.02 worth of TRX for each successful referral!

âœ… **MINIMUM WITHDRAWAL:** Only ${MIN_WITHDRAW_TRX.toFixed(2)} TRX. Fast & Easy!

Join now and grab your free crypto reward:
ðŸ”— ${telegramLink}

See you inside! #Tron #TRX #Crypto #FreeMoney`;
            
            if (navigator.share) {
                navigator.share({ 
                    title: 'Tron Ads Faucet - Free TRX!', 
                    text: shareText 
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    window.Telegram.WebApp.showAlert("Promotional text copied to clipboard! Share it with your friends!");
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                });
            }
        }

        window.applyReferralCode = () => {
            const referrerCode = document.getElementById('enter-referrer-code').value.trim();
            const userRef = rtdbRef(rtdb, 'users/' + userUid); // RTDB Ref

            if (!referrerCode) return window.Telegram.WebApp.showAlert("Please enter a referral code.");
            if (referrerCode === telegramId) return window.Telegram.WebApp.showAlert("You cannot refer yourself.");

            rtdbGet(userRef).then((snapshot) => { // RTDB Get
                if (snapshot.val()?.referred_by) {
                    return window.Telegram.WebApp.showAlert("You have already used a referral code.");
                }
                
                const referrerUid = getUidFromTelegramId(referrerCode); 
                const referrerRef = rtdbRef(rtdb, 'users/' + referrerUid); // RTDB Ref

                rtdbGet(referrerRef).then(rSnapshot => { // RTDB Get
                    if (!rSnapshot.exists()) return window.Telegram.WebApp.showAlert("Invalid referral code. User not found.");
                    
                    const rData = rSnapshot.val();
                    const newReferrerBalance = (rData.balance_usd || 0.0) + REFERRAL_BONUS_USD;
                    
                    rtdbUpdate(referrerRef, { // RTDB Update
                        balance_usd: newReferrerBalance
                    });

                    rtdbUpdate(userRef, { // RTDB Update
                        referred_by: referrerCode,
                        referral_applied_at: serverTimestamp() 
                    }).then(() => {
                        window.Telegram.WebApp.showAlert(`Referral code applied successfully! Your referrer received $${REFERRAL_BONUS_USD} in TRX.`);
                        document.getElementById('enter-referrer-code').value = '';
                    });
                });
            });
        }

        // --- WITHDRAWAL LOGIC (RTDB Balance Update + Firestore Request Creation) ---
        
        const handleWithdrawSubmit = (e) => {
            e.preventDefault();
            const withdrawSubmitBtn = document.getElementById('withdraw-submit-btn');
            
            if (!userUid || !telegramId) {
                return window.Telegram.WebApp.showAlert("Withdrawal failed: User session not loaded. Please restart the bot.");
            }

            const userRef = rtdbRef(rtdb, 'users/' + userUid); // RTDB Ref
            const tronAddress = document.getElementById('tron-address').value.trim();
            const amountInTrx = parseFloat(document.getElementById('amount-trx').value);
            
            if (!tronAddress || !tronAddress.startsWith('T') || tronAddress.length < 34) {
                return window.Telegram.WebApp.showAlert("Please enter a valid TRON address (starts with 'T').");
            }
            if (isNaN(amountInTrx) || amountInTrx <= 0) {
                return window.Telegram.WebApp.showAlert("Please enter a valid amount in TRX.");
            }
            
            if (amountInTrx < MIN_WITHDRAW_TRX) {
                return window.Telegram.WebApp.showAlert(`Withdrawal failed: Minimum withdrawal is ${MIN_WITHDRAW_TRX.toFixed(2)} TRX.`);
            }

            if (amountInTrx > MAX_WITHDRAW_TRX) {
                return window.Telegram.WebApp.showAlert(`Withdrawal failed: Maximum withdrawal is ${MAX_WITHDRAW_TRX.toFixed(2)} TRX.`);
            }
            
            const withdrawUsdAmount = amountInTrx * currentTronPriceUsd;

            withdrawSubmitBtn.disabled = true;

            // 1. RTDB'den Bakiye KontrolÃ¼ (rtdbGet)
            rtdbGet(userRef).then(snapshot => {
                const userData = snapshot.val();
                
                if (!userData) {
                    throw new Error("User data is missing on Firebase.");
                }
                
                const usdBalance = userData.balance_usd || 0.0;
                
                if (withdrawUsdAmount > usdBalance) {
                    const trxBalance = currentTronPriceUsd > 0 ? (usdBalance / currentTronPriceUsd) : 0; 
                    withdrawSubmitBtn.disabled = false;
                    return window.Telegram.WebApp.showAlert(`Withdrawal failed: Insufficient balance. Available TRX: ${trxBalance.toFixed(4)}`);
                }

                const newUsdBalance = usdBalance - withdrawUsdAmount;

                // 2. FIRESTORE'a Ã‡ekim Talebi Ekleme (addDoc)
                const requestsCollection = collection(firestore, "withdrawal_requests");
                
                return addDoc(requestsCollection, {
                    user_id: userUid,
                    telegram_id: telegramId,
                    username: userData.username,
                    tron_address: tronAddress,
                    amount_usd: withdrawUsdAmount.toFixed(4),
                    amount_trx: amountInTrx.toFixed(4),
                    status: "Pending", 
                    timestamp: serverTimestamp()
                }).then(() => {
                    // 3. RTDB'de Bakiye DÃ¼ÅŸÃ¼rme (rtdbUpdate)
                    return rtdbUpdate(userRef, { balance_usd: newUsdBalance });
                });
                
            }).then(() => {
                // BaÅŸarÄ± mesajÄ± gÃ¶ster
                window.Telegram.WebApp.showAlert(`Withdrawal request for ${amountInTrx.toFixed(4)} TRX submitted successfully. Your request is now pending admin approval.`);
                document.getElementById('amount-trx').value = '';
                document.getElementById('withdraw-usd-amount').textContent = '$0.00';
            }).catch(e => {
                console.error("Withdrawal Error:", e);
                
                let errorMessage = "An error occurred during withdrawal. Please try again later.";
                
                if (e.message && e.message.includes("User data is missing")) {
                    errorMessage = "User data could not be initialized. Please restart the bot and try again.";
                } else if (e.code && e.code.includes("permission-denied")) {
                    // Firebase Firestore veya RTDB izin hatasÄ±
                    errorMessage = "Withdrawal failed: Database permission denied. Please check your Firebase Rules.";
                } else if (e.message && e.message.includes("Failed to fetch")) {
                    errorMessage = "Network error: Failed to connect to Firebase. Check your internet.";
                }
                
                window.Telegram.WebApp.showAlert(`Withdrawal failed: ${errorMessage}`);
            }).finally(() => {
                withdrawSubmitBtn.disabled = false;
            });
        }

        // --- ADMIN PANEL LOGIC (RTDB Stats + Firestore Requests) ---
        function loadAdminPanel() {
            if (!ADMIN_TELEGRAM_IDS.includes(telegramId)) return;

            // 1. Load System Stats (RTDB) & Total Ads (RTDB)
            const usersRef = rtdbRef(rtdb, 'users');
            rtdbOnValue(usersRef, (snapshot) => {
                let totalBalance = 0.0;
                let userCount = 0;
                let totalAds = 0; // Yeni: Total Ads
                
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    totalBalance += userData.balance_usd || 0.0;
                    userCount++;
                    // Yeni: Total Ads hesaplama
                    totalAds += userData.lifetime_ads_watched || 0; 
                });
                
                document.getElementById('admin-user-count').textContent = userCount;
                document.getElementById('admin-total-balance').textContent = `$${totalBalance.toFixed(2)}`;
                // Yeni: Total Ads UI gÃ¼ncelleme
                document.getElementById('admin-total-ads').textContent = totalAds.toLocaleString(); 
            });

            // 2. Load Withdrawal Requests (FIRESTORE) - Pending
            const requestsColRef = collection(firestore, 'withdrawal_requests');
            // Firestore Query (sadece Pending olanlarÄ± getirir)
            const q = query(requestsColRef, where("status", "==", "Pending"));
            
            // onSnapshot (Firestore Listener)
            onSnapshot(q, (querySnapshot) => {
                const ul = document.getElementById('withdrawal-list');
                ul.innerHTML = ''; 
                
                const pendingRequests = [];

                querySnapshot.forEach(docSnapshot => {
                    const request = docSnapshot.data();
                    const requestId = docSnapshot.id; // Firestore Document ID
                    
                    // Firestore Timestamp'i milisaniyeye Ã§evirme
                    const timestamp = request.timestamp?.seconds * 1000 || 0; 
                    pendingRequests.push({ ...request, requestId, timestamp });
                });

                pendingRequests.sort((a, b) => a.timestamp - b.timestamp);


                if (pendingRequests.length === 0) {
                    ul.innerHTML = '<p style="color:green; font-weight:700;">No pending withdrawal requests.</p>';
                } else {
                    pendingRequests.forEach(request => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <p><strong>User:</strong> ${request.username} (TG ID: ${request.telegram_id})</p>
                            <p><strong>Address:</strong> <code>${request.tron_address}</code></p>
                            <p><strong>Amount:</strong> ${request.amount_trx} TRX <strong>($${request.amount_usd})</strong></p>
                            <button onclick="processWithdrawal('${request.requestId}', 'Completed')" class="approve-btn"><i class="fas fa-check"></i> Approve</button>
                            <button onclick="processWithdrawal('${request.requestId}', 'Rejected')" class="reject-btn"><i class="fas fa-times"></i> Reject</button>
                        `;
                        ul.appendChild(li);
                    });
                }
            });
            
            // 3. YENÄ°: Load Approved Payments (FIRESTORE)
            const requestsColRefForApproved = collection(firestore, 'withdrawal_requests');
            // Firestore Query (sadece Completed olanlarÄ± getirir)
            const approvedQ = query(requestsColRefForApproved, where("status", "==", "Completed"));
            
            // onSnapshot (Firestore Listener)
            onSnapshot(approvedQ, (querySnapshot) => {
                let totalApprovedUsd = 0.0;

                querySnapshot.forEach(docSnapshot => {
                    const request = docSnapshot.data();
                    totalApprovedUsd += parseFloat(request.amount_usd) || 0.0;
                });

                // UI GÃ¼ncelleme
                document.getElementById('admin-approved-payments').textContent = `$${totalApprovedUsd.toFixed(2)}`;
            });
        }

        window.processWithdrawal = (requestId, status) => {
            if (!ADMIN_TELEGRAM_IDS.includes(telegramId)) return;
            
            // Firestore Document Ref
            const requestDocRef = doc(firestore, 'withdrawal_requests', requestId);
            
            // Firestore Update (updateDoc)
            updateDoc(requestDocRef, {
                status: status,
                processed_by_admin: telegramId,
                processed_at: serverTimestamp()
            }).then(() => {
                window.Telegram.WebApp.showAlert(`Request ${requestId} set to ${status}.`);
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }).catch(e => {
                console.error("Firestore Update Error:", e);
                window.Telegram.WebApp.showAlert(`Admin action failed: ${e.message}`);
            });
        }
        
        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            document.getElementById('watch-ad-btn').addEventListener('click', handleWatchAd);
            document.getElementById('share-ref-btn').addEventListener('click', handleShareReferral);
            document.getElementById('withdraw-form').addEventListener('submit', handleWithdrawSubmit);
            
            // TRX miktarÄ±nÄ± USD'ye Ã§evirme listener'Ä±
            document.getElementById('amount-trx').addEventListener('input', () => {
                const trx = parseFloat(document.getElementById('amount-trx').value);
                const withdrawUsd = document.getElementById('withdraw-usd-amount');
                if (isNaN(trx) || trx <= 0 || currentTronPriceUsd === 0) {
                    withdrawUsd.textContent = '$0.00';
                } else {
                    withdrawUsd.textContent = `$${(trx * currentTronPriceUsd).toFixed(4)}`;
                }
            });

            // Bottom Navigation Buttons
            const navButtons = document.querySelectorAll('.bottom-nav .nav-btn');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = button.dataset.page;
                    window.showSection(pageId); 
                });
            });
        }

        // --- INITIALIZATION ---
        const initApp = async () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            const user = tg.initDataUnsafe.user;
            if (!user || !user.id) {
                tg.showAlert("Could not verify user. Please open this app through Telegram.", () => tg.close());
                return;
            }
            
            telegramId = user.id.toString();
            userUid = getUidFromTelegramId(telegramId);
            
            const referralInput = document.getElementById('referral-code-input');
            if (referralInput) {
                referralInput.value = telegramId;
                referralInput.placeholder = telegramId;
            }

            // Check and handle Admin access
            if (ADMIN_TELEGRAM_IDS.includes(telegramId)) {
                document.getElementById('admin-indicator').style.display = 'block';
                const nav = document.querySelector('.bottom-nav');
                if (!document.querySelector('.nav-btn[data-page="admin-panel"]')) {
                    const adminBtn = document.createElement('button');
                    adminBtn.className = 'nav-btn';
                    adminBtn.dataset.page = 'admin-panel';
                    adminBtn.innerHTML = '<i class="fas fa-user-shield"></i><span>Admin</span>';
                    adminBtn.addEventListener('click', () => showSection('admin-panel')); 
                    nav.appendChild(adminBtn);
                }
            }
            
            await fetchTronPrice();
            setupUserListener();
            setupEventListeners();
            
            showSection('menu-page'); 
        };

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
