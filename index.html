<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tron Ads Faucet</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <script src="https://adexora.com/cdn/ads.js?id=494"></script>

    <style>
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1c1c1e;
            --subtle-text: #888;
            --primary-color: #D32F2F;
            --primary-color-hover: #B71C1C;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        #app { 
            max-width: 500px; 
            margin: 0 auto; 
            padding-bottom: 80px;
            min-height: 100vh;
        }

        .header { 
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background-color: var(--primary-color); 
            color: white; 
            border-radius: 0 0 var(--radius) var(--radius); 
            box-shadow: var(--shadow); 
        }
        .header h1 { font-size: 1.4rem; font-weight: 800; }
        .header-stats { text-align: right; font-size: 0.9rem; }
        .header-stats p strong { display: block; font-size: 1.1rem; }

        main { 
            padding: 15px; 
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        .page { 
            display: none; 
            animation: fadeIn 0.4s ease-in-out;
        }
        .page.active { 
            display: block; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        h2 { 
            font-size: 1.6rem; 
            margin-bottom: 20px; 
            color: var(--primary-color); 
            border-left: 4px solid var(--primary-color); 
            padding-left: 10px; 
        }
        
        .card { 
            padding: 20px; 
            border-radius: var(--radius); 
            background-color: var(--card-bg); 
            box-shadow: var(--shadow); 
            margin-bottom: 15px; 
            transition: transform 0.2s; 
        }
        .card:hover { transform: translateY(-2px); }
        
        .action-btn { 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: #fff; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: background-color 0.2s, transform 0.1s; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background-color: var(--primary-color); 
        }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:hover { background-color: var(--primary-color-hover); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.loading { background-color: #FF5722; cursor: wait; pointer-events: none; }

        .balance-card { 
            text-align: center; 
            border: 2px solid var(--primary-color); 
            background-color: #FFF3F3; 
        }
        .balance-card .usd-value { 
            font-size: 2.5rem; 
            font-weight: 800; 
            color: var(--primary-color); 
            line-height: 1.2; 
        }
        .balance-card .trx-value { 
            font-size: 1.2rem; 
            color: var(--subtle-text); 
            margin-top: 5px; 
        }
        
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 15px; 
        }
        .menu-tile { 
            padding: 15px; 
            border-radius: var(--radius); 
            text-align: center; 
            background-color: var(--card-bg); 
            box-shadow: var(--shadow); 
            cursor: pointer; 
            transition: background-color 0.2s, transform 0.1s; 
        }
        .menu-tile i { 
            font-size: 2rem; 
            color: var(--primary-color); 
            margin-bottom: 10px; 
        }
        .menu-tile span { 
            font-size: 1rem; 
            font-weight: 600; 
            display: block; 
        }
        .menu-tile:hover { background-color: #FFFAFA; }

        .form-group { margin-bottom: 15px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 700; 
            font-size: 0.95rem; 
            color: var(--text-color); 
        }
        input[type="text"], input[type="number"] { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            font-family: inherit; 
            font-size: 1rem; 
            border: 1px solid var(--border-color); 
            transition: border-color 0.2s; 
        }
        input[type="text"]:focus, input[type="number"]:focus { 
            border-color: var(--primary-color); 
            outline: none; 
        }
        
        .input-group { 
            display: flex; 
            margin-bottom: 15px; 
        }
        .input-group input { 
            flex-grow: 1; 
            border-radius: 8px 0 0 8px; 
            border-right: none; 
            background-color: var(--bg-color); 
        }
        .input-group button { 
            padding: 10px 15px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 0 8px 8px 0; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .input-group button:hover { background-color: var(--primary-color-hover); }

        .withdraw-note { 
            font-size: 0.9rem; 
            color: var(--subtle-text); 
            margin-top: 10px; 
        }
        
        #admin-panel .stat-display { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px dashed var(--border-color); 
            font-weight: 600; 
        }
        #admin-panel h3 { 
            margin-top: 20px; 
            color: var(--primary-color); 
            font-size: 1.2rem;
        }
        #admin-panel ul { 
            list-style: none; 
            padding: 0; 
            max-height: 400px;
            overflow-y: auto;
        }
        #admin-panel li { 
            border: 1px solid var(--primary-color); 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 10px; 
            background-color: #FFEEEE; 
        }
        #admin-panel li strong { color: var(--primary-color); }
        #admin-panel li button { 
            margin-top: 10px; 
            margin-right: 5px; 
            padding: 8px 12px; 
            border-radius: 5px; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 0.9rem;
        }
        #admin-panel .approve-btn { background-color: #4CAF50; color: white; border: none; }
        #admin-panel .reject-btn { background-color: #f44336; color: white; border: none; }
        #admin-panel .orange-btn { background-color: #ff9800; color: white; border: none; }

        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            max-width: 500px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-around; 
            padding: 5px 0; 
            background-color: var(--card-bg); 
            border-top: 1px solid var(--border-color); 
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); 
            z-index: 1000; 
        }
        .nav-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 5px 10px; 
            font-family: var(--font-family); 
            font-size: 0.75rem; 
            transition: color 0.2s; 
            flex-grow: 1; 
            color: var(--subtle-text); 
        }
        .nav-btn i { 
            font-size: 1.6rem; 
            margin-bottom: 3px; 
        }
        .nav-btn.active { 
            font-weight: 700; 
            color: var(--primary-color); 
        }

        .user-stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            margin: 10px 0; 
        }
        .stat-item { 
            background: #f5f5f5; 
            padding: 8px; 
            border-radius: 5px; 
            text-align: center; 
        }
        .stat-value { 
            font-weight: 800; 
            color: var(--primary-color); 
            font-size: 1.1rem; 
        }

        .scrollable-section {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 10px;
            margin-top: 10px;
        }

        .admin-section {
            margin-bottom: 20px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color-hover);
        }
    </style>
</head>
<body>

    <div id="app">
        <header class="header">
            <div>
                <h1>TRON Ads Faucet</h1>
                <p style="font-size:0.9rem;">The simplest way to earn TRX.</p>
            </div>
            <div class="header-stats">
                <p>Current Price (TRX)</p>
                <p><strong>$<span id="current-trx-price">0.0000</span></strong></p>
                <div id="admin-indicator" style="display:none; font-weight:bold; color:#FFD700; margin-top:5px;">ADMIN MODE</div>
            </div>
        </header>

        <main id="main-content">
            
            <div id="admin-panel" class="page">
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                
                <div class="admin-section">
                    <div class="card">
                        <h3>System Stats (RTDB)</h3>
                        <div class="stat-display"><span>Total Users:</span> <strong id="admin-user-count">0</strong></div>
                        <div class="stat-display"><span>Total User Balance (USD):</span> <strong id="admin-total-balance">$0.00</strong></div>
                        <div class="stat-display"><span>Total Ads Watched:</span> <strong id="admin-total-ads">0</strong></div>
                        <div class="stat-display"><span>Total Referrals:</span> <strong id="admin-total-referrals">0</strong></div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h3>User IP Management</h3>
                        <div class="input-group">
                            <input type="text" id="user-ip-input" placeholder="User IP to ban">
                            <button onclick="banUserIP()"><i class="fas fa-ban"></i> Ban IP</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="loadAllUsersWithIPs()" class="action-btn" style="padding: 10px;">
                                <i class="fas fa-sync-alt"></i> Refresh Users with IPs
                            </button>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h3>All Users with IPs</h3>
                        <div class="scrollable-section">
                            <ul id="users-ip-list">
                                <p style="color:var(--subtle-text);">Click refresh to load users...</p>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h3>Banned IPs</h3>
                        <div class="scrollable-section">
                            <ul id="banned-ips-list">
                                <p style="color:var(--subtle-text);">Loading banned IPs...</p>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h3>Banned Users</h3>
                        <div class="scrollable-section">
                            <ul id="banned-users-list">
                                <p style="color:var(--subtle-text);">Loading banned users...</p>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3>Pending Withdrawal Requests (Firestore)</h3>
                    <div class="scrollable-section">
                        <ul id="withdrawal-list">
                            <p style="color:var(--subtle-text);">Loading requests...</p>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="menu-page" class="page active">
                <h2><i class="fas fa-home"></i> Home & Earning</h2>
                <div class="card balance-card">
                    <p style="font-size:1.1rem; color:var(--subtle-text);">Your Current Balance (TRX)</p>
                    <div class="usd-value"><span id="menu-balance-trx">0.0000</span> TRX</div>
                    <div class="trx-value">≈ $<span id="menu-balance-usd">0.00</span></div>
                </div>
                
                <div class="card" style="text-align: center; border-left: 5px solid var(--primary-color);">
                    <i class="fas fa-video" style="font-size:3rem; color: var(--primary-color);"></i>
                    <h3>Watch & Earn</h3>
                    <p style="margin-bottom:15px;">You earn **$0.001** worth of TRX per rewarded ad.</p>
                    <button id="watch-ad-btn" class="action-btn">
                        <i class="fas fa-play-circle" style="margin-right:10px;"></i> Watch Ad
                    </button>
                    <p class="withdraw-note" style="margin-top:10px;">Ads Watched Today: <strong id="daily-ads-watched">0</strong> / 100</p>
                </div>

                <div class="menu-grid" style="margin-top: 15px;">
                    <div onclick="showSection('friends-page')" class="menu-tile">
                        <i class="fas fa-users"></i>
                        <span>Friends & Referrals</span>
                    </div>
                    <div onclick="showSection('withdraw-page')" class="menu-tile">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw TRX</span>
                    </div>
                </div>
            </div>

            <div id="friends-page" class="page">
                <h2><i class="fas fa-user-friends"></i> Referral System</h2>
                <div class="card">
                    <p style="font-weight:700; color:var(--primary-color);">Referral Bonus: Get **$0.02** worth of TRX for every successful friend!</p>
                    
                    <h3 style="font-size:1.2rem; margin-top:15px; margin-bottom:5px;">Your Referral Link (Share this!)</h3>
                    <div class="input-group">
                        <input type="text" id="referral-code-input" value="" placeholder="Loading..." readonly>
                        <button onclick="copyToClipboard('referral-code-input')"><i class="fas fa-copy"></i> Copy Link</button>
                    </div>
                    
                    <button id="share-ref-btn" class="action-btn" style="margin-top:0;"><i class="fas fa-share-alt" style="margin-right:10px;"></i> Share Promotional Text</button>

                    <h3 style="font-size:1.2rem; margin-top:25px; margin-bottom:5px;">Enter Friend's Code</h3>
                    <p class="withdraw-note">You can only use one code once.</p>
                    <div class="input-group">
                        <input type="text" id="enter-referrer-code" placeholder="Enter friend's Telegram ID">
                        <button onclick="applyReferralCode()"><i class="fas fa-arrow-right"></i> Apply</button>
                    </div>
                </div>
            </div>
            
            <div id="withdraw-page" class="page">
                <h2><i class="fas fa-money-check-alt"></i> Withdraw TRX</h2>
                <div class="card balance-card" style="margin-bottom: 20px;">
                    <p style="font-size:0.9rem; color:var(--subtle-text);">Available TRX:</p>
                    <div class="usd-value" style="font-size:2rem;"><span id="withdraw-balance-trx">0.0000</span> TRX</div>
                </div>
                <p style="font-weight:700;">Minimum withdrawal: **2.50 TRX**.<br>Maximum withdrawal: **10.00 TRX**.</p>
                <form id="withdraw-form" style="margin-top:15px;">
                    <div class="form-group">
                        <label for="tron-address"><i class="fas fa-truck-moving"></i> TRON Wallet Address:</label>
                        <input type="text" id="tron-address" placeholder="Txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    </div>
                    <div class="form-group">
                        <label for="amount-trx"><i class="fas fa-coins"></i> Amount (TRX):</label>
                        <input type="number" id="amount-trx" step="0.001" placeholder="e.g., 2.50" required>
                    </div>
                    <p class="withdraw-note">This equals: <strong id="withdraw-usd-amount">$0.00</strong> USD</p>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn" style="margin-top:15px;">
                        <i class="fas fa-paper-plane" style="margin-right:10px;"></i> Submit Withdrawal Request
                    </button>
                </form>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="menu-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="friends-page"><i class="fas fa-users"></i><span>Friends</span></button>
            <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
        </nav>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref as rtdbRef, get as rtdbGet, set as rtdbSet, update as rtdbUpdate, onValue as rtdbOnValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAYJqf6Y090mN4fjQAR9m7hNil7hjn0HMg",
            authDomain: "tronadsfaucet-fd451.firebaseapp.com",
            databaseURL: "https://tronadsfaucet-fd451-default-rtdb.firebaseio.com",
            projectId: "tronadsfaucet-fd451",
            storageBucket: "tronadsfaucet-fd451.firebasestorage.app",
            messagingSenderId: "110511122993",
            appId: "1:110511122993:web:99099461844e1fbbe10310",
            measurementId: "G-VZ3Z6SFMXZ"
        };
        const ADMIN_TELEGRAM_IDS = ["7904032877", "8392479231"]; 
        const AD_LIMIT = 100;
        const EARNINGS_PER_AD_USD = 0.001;
        const REFERRAL_BONUS_USD = 0.02;
        const MIN_WITHDRAW_TRX = 2.5;
        const MAX_WITHDRAW_TRX = 10.00; 
        const BOT_USERNAME = "TronAdsFaucetBot"; 
        
        const SECURITY_CONFIG = {
            MAX_BALANCE_INCREASE_PER_MINUTE: 0.05, // Daha sıkı: Dakikada $0.05'ten fazla artış
            MAX_ADS_PER_MINUTE: 3, // Daha sıkı: Dakikada 3 reklam
            SUSPICIOUS_ACTIVITY_LIMIT: 2, // 2 şüpheli işlemde ban
            CHECK_INTERVAL: 30000, // 30 saniyede bir kontrol
            MAX_BALANCE_WITHOUT_ADS: 0.10 // Reklamsız maksimum bakiye
        };

        let currentTronPriceUsd = 0.0; 
        let userUid = null;
        let telegramId = null;
        let lastBalance = 0;
        let lastBalanceUpdate = Date.now();
        let userActivity = [];

        const app = initializeApp(FIREBASE_CONFIG);
        const rtdb = getDatabase(app);
        const firestore = getFirestore(app);

        const getUidFromTelegramId = (id) => `tg_user_${id}`;
        
        // IP BAN CHECK - GÜNCEL
        async function checkIPBan() {
            try {
                const userIP = await getUserIP();
                const bannedIPRef = rtdbRef(rtdb, 'banned_ips/' + userIP.replace(/\./g, '_'));
                
                const snapshot = await rtdbGet(bannedIPRef);
                if (snapshot.exists()) {
                    const banData = snapshot.val();
                    const banReason = banData.reason || "Security violation";
                    const bannedBy = banData.banned_by || "Administrator";
                    const banDate = banData.banned_at ? new Date(banData.banned_at).toLocaleString() : "Unknown";
                    
                    // Full screen ban mesajı
                    document.body.innerHTML = `
                        <div style="
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
                            color: white;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            text-align: center;
                            padding: 20px;
                            font-family: 'Nunito', sans-serif;
                            z-index: 9999;
                        ">
                            <div style="font-size: 4rem; margin-bottom: 20px;">🚫</div>
                            <h1 style="font-size: 2rem; margin-bottom: 20px; font-weight: 800;">ACCOUNT BANNED</h1>
                            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; max-width: 400px;">
                                <p style="margin-bottom: 10px;"><strong>Reason:</strong> ${banReason}</p>
                                <p style="margin-bottom: 10px;"><strong>Banned by:</strong> ${bannedBy}</p>
                                <p style="margin-bottom: 10px;"><strong>Date:</strong> ${banDate}</p>
                                <p style="margin-bottom: 10px;"><strong>Your IP:</strong> ${userIP}</p>
                            </div>
                            <p style="margin-top: 30px; opacity: 0.8;">
                                If you believe this is a mistake, please contact support.
                            </p>
                            <button onclick="window.Telegram.WebApp.close()" style="
                                margin-top: 20px;
                                padding: 12px 30px;
                                background: white;
                                color: #D32F2F;
                                border: none;
                                border-radius: 10px;
                                font-weight: 700;
                                cursor: pointer;
                                font-size: 1.1rem;
                            ">
                                Close App
                            </button>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        window.Telegram.WebApp.close();
                    }, 10000);
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error("IP ban check error:", error);
                return false;
            }
        }

        // GELİŞMİŞ HİLE TESPİT SİSTEMİ
        function detectSuspiciousActivity(userData, previousData) {
            const suspiciousFlags = [];
            const now = Date.now();
            const timeDiff = (now - lastBalanceUpdate) / 1000 / 60; // Dakika cinsinden
            
            if (!previousData) return suspiciousFlags;
            
            // Bakiye artış kontrolü
            const balanceIncrease = userData.balance_usd - (previousData.balance_usd || 0);
            if (balanceIncrease > SECURITY_CONFIG.MAX_BALANCE_INCREASE_PER_MINUTE && timeDiff < 1) {
                suspiciousFlags.push(`Anormal bakiye artışı: $${balanceIncrease.toFixed(4)} (${timeDiff.toFixed(1)} dakikada)`);
            }
            
            // Reklam hızı kontrolü
            const adsIncrease = userData.daily_ads_watched - (previousData.daily_ads_watched || 0);
            if (adsIncrease > SECURITY_CONFIG.MAX_ADS_PER_MINUTE && timeDiff < 1) {
                suspiciousFlags.push(`Anormal reklam hızı: ${adsIncrease} ads (${timeDiff.toFixed(1)} dakikada)`);
            }
            
            // Negatif bakiye kontrolü
            if (userData.balance_usd < 0) {
                suspiciousFlags.push(`Negatif bakiye: $${userData.balance_usd}`);
            }
            
            // Reklamsız bakiye artışı
            const hasAdActivity = userData.last_ad_viewed && 
                                (now - userData.last_ad_viewed) < 300000; // Son 5 dakikada reklam
            if (balanceIncrease > 0 && !hasAdActivity && balanceIncrease > SECURITY_CONFIG.MAX_BALANCE_WITHOUT_ADS) {
                suspiciousFlags.push(`Reklamsız bakiye artışı: $${balanceIncrease.toFixed(4)}`);
            }
            
            // Aktivite loglama
            userActivity.push({
                timestamp: now,
                balance: userData.balance_usd,
                ads: userData.daily_ads_watched,
                increase: balanceIncrease
            });
            
            // Son 10 aktiviteyi tut
            if (userActivity.length > 10) {
                userActivity = userActivity.slice(-10);
            }
            
            return suspiciousFlags;
        }

        // OTO BAN SİSTEMİ
        async function autoBanIP(ip, reason, userUid, telegramId) {
            const banRef = rtdbRef(rtdb, 'banned_ips/' + ip.replace(/\./g, '_'));
            const activityRef = rtdbRef(rtdb, 'suspicious_activity/' + userUid + '/' + Date.now());
            
            const banData = {
                ip: ip,
                user_id: userUid,
                telegram_id: telegramId,
                reason: reason,
                banned_at: serverTimestamp(),
                banned_by: 'AUTO_SYSTEM',
                auto_banned: true
            };
            
            const activityData = {
                ip: ip,
                user_id: userUid,
                telegram_id: telegramId,
                reason: reason,
                detected_at: serverTimestamp(),
                action_taken: 'AUTO_BANNED',
                activity_log: userActivity
            };
            
            await Promise.all([
                rtdbSet(banRef, banData),
                rtdbSet(activityRef, activityData)
            ]);
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            await rtdbUpdate(userRef, {
                balance_usd: 0,
                daily_ads_watched: 0,
                total_ads_watched: 0,
                is_banned: true,
                ban_reason: reason,
                banned_at: serverTimestamp()
            });
        }

        // GÜVENLİK İZLEYİCİSİ
        function setupSecurityMonitor() {
            if (!userUid) return;
            
            let previousUserData = null;
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            rtdbOnValue(userRef, async (snapshot) => {
                const currentData = snapshot.val();
                if (!currentData) return;
                
                if (previousUserData) {
                    const suspiciousActivities = detectSuspiciousActivity(currentData, previousUserData);
                    
                    if (suspiciousActivities.length > 0) {
                        const userIP = await getUserIP();
                        const reason = `HILE_TESPITI: ${suspiciousActivities.join(' | ')}`;
                        
                        const suspicionCount = (currentData.suspicion_count || 0) + 1;
                        await rtdbUpdate(userRef, { 
                            suspicion_count: suspicionCount,
                            last_suspicion: serverTimestamp(),
                            suspicion_reasons: [...(currentData.suspicion_reasons || []), {
                                reason: reason,
                                timestamp: serverTimestamp(),
                                balance: currentData.balance_usd,
                                ads: currentData.daily_ads_watched
                            }]
                        });
                        
                        if (suspicionCount >= SECURITY_CONFIG.SUSPICIOUS_ACTIVITY_LIMIT) {
                            await autoBanIP(userIP, reason, userUid, telegramId);
                            // Ban mesajı checkIPBan tarafından gösterilecek
                        }
                    }
                }
                
                previousUserData = currentData;
                lastBalance = currentData.balance_usd || 0;
                lastBalanceUpdate = Date.now();
            });
        }

        // KULLANICI IP KAYDET
        async function saveUserIP() {
            if (!userUid) return;
            
            const userIP = await getUserIP();
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            
            rtdbGet(userRef).then((snapshot) => {
                const userData = snapshot.val() || {};
                rtdbUpdate(userRef, {
                    last_ip: userIP,
                    ip_updated_at: serverTimestamp(),
                    first_ip: userData.first_ip || userIP
                });
            });
        }

        // DİĞER FONKSİYONLAR AYNI KALIYOR...
        // [Previous functions remain the same, just adding the new security features]
        
        window.showSection = (sectionId) => {
            document.querySelectorAll('.page').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-page="${sectionId}"]`)?.classList.add('active');

            if (sectionId === 'admin-panel') {
                loadAdminPanel();
                loadBannedIPs();
                loadBannedUsers();
            }
        }

        window.copyToClipboard = (elementId) => {
            const copyText = document.getElementById(elementId);
            const code = copyText.value;
            const fullLink = `https://t.me/${BOT_USERNAME}?start=${code}`;

            navigator.clipboard.writeText(fullLink).then(() => {
                window.Telegram.WebApp.showAlert("Referral Link copied to clipboard!");
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }).catch(err => {
                 window.Telegram.WebApp.showAlert(`Failed to copy: ${err}`);
            });
        }
        
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        // Kalan fonksiyonlar önceki kodla aynı...
        // [Rest of the functions remain unchanged from previous implementation]

        // INIT APP - GÜNCEL
        const initApp = async () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // Önce IP ban kontrolü
            const isBanned = await checkIPBan();
            if (isBanned) return;
            
            const user = tg.initDataUnsafe.user;
            if (!user || !user.id) {
                tg.showAlert("Could not verify user. Please open this app through Telegram.", () => tg.close());
                return;
            }
            
            telegramId = user.id.toString();
            userUid = getUidFromTelegramId(telegramId);
            
            // Kullanıcı IP'sini kaydet
            await saveUserIP();
            
            const referralInput = document.getElementById('referral-code-input');
            if (referralInput) {
                referralInput.value = telegramId;
                referralInput.placeholder = telegramId;
            }

            if (ADMIN_TELEGRAM_IDS.includes(telegramId)) {
                document.getElementById('admin-indicator').style.display = 'block';
                const nav = document.querySelector('.bottom-nav');
                if (!document.querySelector('.nav-btn[data-page="admin-panel"]')) {
                    const adminBtn = document.createElement('button');
                    adminBtn.className = 'nav-btn';
                    adminBtn.dataset.page = 'admin-panel';
                    adminBtn.innerHTML = '<i class="fas fa-user-shield"></i><span>Admin</span>';
                    adminBtn.addEventListener('click', () => showSection('admin-panel')); 
                    nav.appendChild(adminBtn);
                }
            }
            
            await fetchTronPrice();
            setupUserListener();
            setupEventListeners();
            setupSecurityMonitor();
            
            showSection('menu-page'); 
        };

        document.addEventListener('DOMContentLoaded', initApp);

        // Diğer fonksiyonlar önceki implementasyondan alınacak...
        // [Include all the previous functions for user management, admin panel, etc.]
    </script>
</body>
</html>
